<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä½•å³°-ä¸“ç”¨è®°äº‹æœ¬</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Supabase JS å®¢æˆ·ç«¯ -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- SortableJS -->
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.14.0/Sortable.min.js"></script>
    
    <style>
        /* åŸæœ‰çš„æ‰€æœ‰CSSæ ·å¼ä¿æŒä¸å˜ */
        :root {
            --primary: #4361ee;
            --secondary: #3f37c9;
            --success: #4cc9f0;
            --danger: #f72585;
            --warning: #f8961e;
            --info: #4895ef;
            --light: #f8f9fa;
            --dark: #212529;
            --gray: #6c757d;
            --urgent: #ff4d4d;
            --important: #ff9f1c;
            --normal: #2ec4b6;
            --low: #cbf3f0;
            --background: #f5f7fa;
            --card-bg: #ffffff;
            --text-primary: #333333;
            --text-secondary: #666666;
            --border: #e0e0e0;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', 'PingFang SC', 'Microsoft YaHei', sans-serif;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--background);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.6;
        }
        
        /* æ‰€æœ‰åŸæœ‰çš„CSSæ ·å¼ä¿æŒä¸å˜ */
        /* ... è¿™é‡Œçœç•¥äº†åŸæœ‰çš„CSSæ ·å¼ä»¥èŠ‚çœç©ºé—´ ... */
        
        /* æ–°å¢æ ·å¼ï¼šæ ‡ç­¾åˆ é™¤æŒ‰é’® */
        .custom-tag-delete {
            margin-left: 5px;
            cursor: pointer;
            font-size: 10px;
            opacity: 0.7;
            padding: 1px 3px;
            border-radius: 50%;
            background-color: rgba(255, 255, 255, 0.3);
        }
        
        .custom-tag-delete:hover {
            opacity: 1;
            background-color: rgba(255, 255, 255, 0.5);
        }
        
        /* ç²˜è´´ä¸Šä¼ æç¤º */
        .paste-hint {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: var(--primary);
            color: white;
            padding: 10px 15px;
            border-radius: 8px;
            font-size: 14px;
            box-shadow: var(--shadow);
            z-index: 1000;
            display: none;
            animation: fadeInOut 3s ease-in-out;
        }
        
        @keyframes fadeInOut {
            0% { opacity: 0; transform: translateY(10px); }
            20% { opacity: 1; transform: translateY(0); }
            80% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(-10px); }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen p-4 flex items-center justify-center">
    <!-- ç²˜è´´ä¸Šä¼ æç¤º -->
    <div class="paste-hint" id="pasteHint">å·²ç²˜è´´å›¾ç‰‡ï¼Œæ­£åœ¨ä¸Šä¼ ...</div>
    
    <!-- åŸæœ‰çš„HTMLç»“æ„ä¿æŒä¸å˜ -->
    <!-- ... è¿™é‡Œçœç•¥äº†åŸæœ‰çš„HTMLç»“æ„ä»¥èŠ‚çœç©ºé—´ ... -->
    
    <script src="config.js"></script>
    <script>
        // åˆå§‹åŒ–å˜é‡
        let tasks = [];
        let deletedTasks = [];
        let operationLogs = [];
        let yesterdayUncompletedTasks = [];
        let taskSuggestions = [];
        let categories = {};
        let images = [];
        let folders = [];
        let supabase = null;
        
        // å½“å‰é€‰ä¸­çš„ä¼˜å…ˆçº§
        let currentPriority = 1;
        let currentView = 'quadrant';
        let editingTaskId = null;
        let editingSuggestionIndex = -1;
        let editingImageId = null;
        let editingFolderId = null;
        let currentLogPage = 1;
        const logPageSize = 10;
        let inactivityTimer;
        const INACTIVITY_TIMEOUT = 15 * 60 * 1000; // 15åˆ†é’Ÿ
        
        // å½“å‰ç­›é€‰çŠ¶æ€
        let currentFilter = {
            startDate: null,
            endDate: null,
            quickFilter: 'today'
        };
        
        // åˆ—è¡¨è§†å›¾æ’åºæ–¹å¼
        let listSortMethod = 'date';
        
        // å›¾ç‰‡åˆ†ç±»ç­›é€‰
        let imageCategoryFilter = 'all';
        
        // å›¾ç‰‡æ‡’åŠ è½½è§‚å¯Ÿå™¨
        let imageObserver = null;
        
        // è‡ªå®šä¹‰æ ‡ç­¾
        let customTags = [];
        let editingTagId = null;
        
        // åˆå§‹åŒ–é¡µé¢
        document.addEventListener('DOMContentLoaded', function() {
            // åˆå§‹åŒ–Supabase
            initSupabase();
            
            // åˆå§‹åŒ–å›¾ç‰‡æ‡’åŠ è½½
            initImageLazyLoading();
            
            // æ£€æŸ¥ç™»å½•çŠ¶æ€
            checkLoginStatus();
            
            // è®¾ç½®å½“å‰æ—¥æœŸ
            updateCurrentDate();
            
            // åŠ è½½è‡ªå®šä¹‰æ ‡ç­¾
            loadCustomTags();
            
            // åŠ è½½æ–‡ä»¶å¤¹æ•°æ®
            loadFolders();
            
            // ç­‰å¾…Chart.jsåŠ è½½å®Œæˆåå†åˆå§‹åŒ–å›¾è¡¨
            waitForChartJS().then(() => {
                initChart();
                initAnalyticsCharts();
            }).catch(error => {
                console.error('æ— æ³•åŠ è½½Chart.js:', error);
                // å³ä½¿å›¾è¡¨æ— æ³•åŠ è½½ï¼Œä¹Ÿè¦ç¡®ä¿å…¶ä»–åŠŸèƒ½æ­£å¸¸
                document.querySelectorAll('.chart-container').forEach(container => {
                    container.innerHTML = '<p>å›¾è¡¨åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•</p>';
                });
            });
            
            // æ›´æ–°ä»»åŠ¡ç»Ÿè®¡
            updateTaskStats();
            
            // ä¼˜å…ˆçº§é€‰æ‹©å™¨äº‹ä»¶
            document.querySelectorAll('.priority-option').forEach(option => {
                option.addEventListener('click', function() {
                    document.querySelectorAll('.priority-option').forEach(opt => {
                        opt.classList.remove('selected');
                    });
                    this.classList.add('selected');
                    currentPriority = parseInt(this.dataset.priority);
                });
            });
            
            // æ·»åŠ ä»»åŠ¡æŒ‰é’®äº‹ä»¶
            document.getElementById('addTaskBtn').addEventListener('click', addNewTask);
            
            // å„è±¡é™æ·»åŠ ä»»åŠ¡æŒ‰é’®äº‹ä»¶
            document.querySelectorAll('.add-task-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const quadrant = parseInt(this.dataset.quadrant);
                    const input = this.previousElementSibling.querySelector('.add-task-input');
                    const text = input.value.trim();
                    
                    if (text) {
                        addTaskToQuadrant(text, quadrant);
                        input.value = '';
                        hideSuggestions(quadrant);
                    } else {
                        // å¦‚æœæ²¡æœ‰è¾“å…¥å†…å®¹ï¼Œåˆ›å»ºä¸€ä¸ªç©ºä»»åŠ¡å¹¶æ‰“å¼€ç¼–è¾‘æ¨¡æ€æ¡†
                        createEmptyTask(quadrant);
                    }
                });
            });
            
            // å„è±¡é™è¾“å…¥æ¡†å›è½¦äº‹ä»¶
            document.querySelectorAll('.add-task-input').forEach(input => {
                input.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        const btn = this.closest('.add-task').querySelector('.add-task-btn');
                        const text = this.value.trim();
                        const quadrant = parseInt(this.dataset.quadrant);
                        
                        if (text) {
                            addTaskToQuadrant(text, quadrant);
                            this.value = '';
                            hideSuggestions(quadrant);
                        } else {
                            // å¦‚æœæ²¡æœ‰è¾“å…¥å†…å®¹ï¼Œåˆ›å»ºä¸€ä¸ªç©ºä»»åŠ¡å¹¶æ‰“å¼€ç¼–è¾‘æ¨¡æ€æ¡†
                            createEmptyTask(quadrant);
                        }
                    }
                });
                
                // è¾“å…¥æ¡†è·å–ç„¦ç‚¹æ—¶æ˜¾ç¤ºå»ºè®®
                input.addEventListener('focus', function() {
                    const quadrant = parseInt(this.dataset.quadrant);
                    if (this.value.trim()) {
                        showSuggestions(this.value, quadrant);
                    }
                });
                
                // è¾“å…¥æ¡†è¾“å…¥æ—¶æ›´æ–°å»ºè®®
                input.addEventListener('input', function() {
                    const quadrant = parseInt(this.dataset.quadrant);
                    if (this.value.trim()) {
                        showSuggestions(this.value, quadrant);
                    } else {
                        hideSuggestions(quadrant);
                    }
                });
                
                // è¾“å…¥æ¡†å¤±å»ç„¦ç‚¹æ—¶éšè—å»ºè®®
                input.addEventListener('blur', function() {
                    setTimeout(() => {
                        const quadrant = parseInt(this.dataset.quadrant);
                        hideSuggestions(quadrant);
                    }, 200);
                });
            });
            
            // ä¸»è¾“å…¥æ¡†äº‹ä»¶
            const mainInput = document.getElementById('newTaskInput');
            mainInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    addNewTask();
                }
            });
            
            mainInput.addEventListener('focus', function() {
                if (this.value.trim()) {
                    showSuggestions(this.value, null);
                }
            });
            
            mainInput.addEventListener('input', function() {
                if (this.value.trim()) {
                    showSuggestions(this.value, null);
                } else {
                    hideSuggestions(null);
                }
            });
            
            mainInput.addEventListener('blur', function() {
                setTimeout(() => {
                    hideSuggestions(null);
                }, 200);
            });
            
            // ä»»åŠ¡å¤é€‰æ¡†äº‹ä»¶
            document.addEventListener('change', function(e) {
                if (e.target.classList.contains('task-checkbox')) {
                    const taskItem = e.target.closest('.task-item, .list-row');
                    if (taskItem) {
                        const taskId = parseInt(taskItem.dataset.id);
                        const task = tasks.find(t => t.id === taskId);
                        if (task) {
                            task.completed = e.target.checked;
                            taskItem.classList.toggle('completed', task.completed);
                            
                            // æ›´æ–°æ•°æ®åº“
                            updateTaskInDatabase(task);
                            
                            // è®°å½•æ“ä½œæ—¥å¿—
                            logOperation(task.completed ? 'complete' : 'incomplete', 
                                         `æ ‡è®°ä»»åŠ¡ä¸º${task.completed ? 'å·²å®Œæˆ' : 'æœªå®Œæˆ'}ï¼š"${task.text}"ï¼ˆè±¡é™ï¼š${getQuadrantName(task.quadrant)}ï¼‰`);
                            
                            updateTaskStats();
                            resetInactivityTimer();
                        }
                    }
                }
            });
            
            // åˆ é™¤æŒ‰é’®äº‹ä»¶
            document.addEventListener('click', function(e) {
                if (e.target.classList.contains('delete-btn')) {
                    const taskItem = e.target.closest('.task-item, .list-row');
                    if (taskItem) {
                        const taskId = parseInt(taskItem.dataset.id);
                        deleteTask(taskId);
                        resetInactivityTimer();
                    }
                }
            });
            
            // ç¼–è¾‘æŒ‰é’®äº‹ä»¶
            document.addEventListener('click', function(e) {
                if (e.target.classList.contains('edit-btn')) {
                    const taskItem = e.target.closest('.task-item, .list-row');
                    if (taskItem) {
                        const taskId = parseInt(taskItem.dataset.id);
                        openEditModal(taskId);
                        resetInactivityTimer();
                    }
                }
            });
            
            // æ‰¹é‡æ“ä½œæŒ‰é’®äº‹ä»¶
            document.getElementById('deleteSelectedTasksBtn').addEventListener('click', deleteSelectedTasks);
            document.getElementById('deleteCompletedTasksBtn').addEventListener('click', deleteCompletedTasks);
            document.getElementById('clearAllTasksBtn').addEventListener('click', clearAllTasks);
            document.getElementById('restoreDeletedBtn').addEventListener('click', showDeletedTasks);
            
            // æ ‡ç­¾åˆ‡æ¢äº‹ä»¶
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                    
                    currentView = this.dataset.view;
                    switchView(currentView);
                    saveViewPreference();
                    resetInactivityTimer();
                });
            });
            
            // æ¨¡æ€æ¡†äº‹ä»¶
            document.getElementById('closeModal').addEventListener('click', closeEditModal);
            document.getElementById('cancelEdit').addEventListener('click', closeEditModal);
            document.getElementById('saveEdit').addEventListener('click', saveEditedTask);
            
            // å·²åˆ é™¤ä»»åŠ¡æ¨¡æ€æ¡†äº‹ä»¶
            document.getElementById('closeDeletedModal').addEventListener('click', closeDeletedTasksModal);
            document.getElementById('closeDeletedModalBtn').addEventListener('click', closeDeletedTasksModal);
            document.getElementById('restoreSelectedTasksBtn').addEventListener('click', restoreSelectedTasks);
            document.getElementById('clearDeletedSearchBtn').addEventListener('click', clearDeletedTasksSearch);
            
            // æœç´¢å·²åˆ é™¤ä»»åŠ¡
            document.getElementById('searchDeletedTasks').addEventListener('input', filterDeletedTasks);
            
            // ç™»å½•è¡¨å•äº‹ä»¶
            document.getElementById('loginForm').addEventListener('submit', function(e) {
                e.preventDefault();
                const password = document.getElementById('password').value;
                const savedPassword = localStorage.getItem('userPassword') || '6858'; // é»˜è®¤å¯†ç 
                if (password === savedPassword) {
                    loginSuccess();
                } else {
                    alert('å¯†ç é”™è¯¯ï¼Œè¯·é‡æ–°è¾“å…¥');
                }
            });
            
            // ä¿®æ”¹å¯†ç æŒ‰é’®äº‹ä»¶
            document.getElementById('changePasswordBtn').addEventListener('click', function() {
                showModal('changePasswordModal');
            });
            
            // å…³é—­ä¿®æ”¹å¯†ç æ¨¡æ€æ¡†
            document.getElementById('closeChangePasswordModal').addEventListener('click', function() {
                hideModal('changePasswordModal');
            });
            
            document.getElementById('cancelChangePassword').addEventListener('click', function() {
                hideModal('changePasswordModal');
            });
            
            // ä¿å­˜æ–°å¯†ç 
            document.getElementById('saveNewPassword').addEventListener('click', function() {
                const currentPassword = document.getElementById('currentPassword').value;
                const newPassword = document.getElementById('newPassword').value;
                const confirmPassword = document.getElementById('confirmPassword').value;
                
                const savedPassword = localStorage.getItem('userPassword') || '6858'; // é»˜è®¤å¯†ç 
                
                if (currentPassword !== savedPassword) {
                    alert('å½“å‰å¯†ç ä¸æ­£ç¡®');
                    return;
                }
                
                if (newPassword !== confirmPassword) {
                    alert('æ–°å¯†ç å’Œç¡®è®¤å¯†ç ä¸åŒ¹é…');
                    return;
                }
                
                if (newPassword.length < 4) {
                    alert('å¯†ç é•¿åº¦ä¸èƒ½å°‘äº4ä½');
                    return;
                }
                
                localStorage.setItem('userPassword', newPassword);
                alert('å¯†ç ä¿®æ”¹æˆåŠŸï¼Œè¯·ä½¿ç”¨æ–°å¯†ç ç™»å½•');
                hideModal('changePasswordModal');
                document.getElementById('currentPassword').value = '';
                document.getElementById('newPassword').value = '';
                document.getElementById('confirmPassword').value = '';
                
                // è®°å½•æ“ä½œæ—¥å¿—
                logOperation('system', 'ç”¨æˆ·ä¿®æ”¹äº†ç™»å½•å¯†ç ');
            });
            
            // é€€å‡ºç™»å½•æŒ‰é’®äº‹ä»¶
            document.getElementById('logoutBtn').addEventListener('click', function() {
                logout();
            });
            
            // å¿«æ·ç­›é€‰å˜æ›´äº‹ä»¶
            document.getElementById('quickDateFilter').addEventListener('change', function() {
                applyQuickFilter();
            });
            
            // æ—¥æœŸé€‰æ‹©å™¨äº‹ä»¶
            document.getElementById('startDate').addEventListener('change', function() {
                const startDate = new Date(this.value);
                const endDate = new Date(document.getElementById('endDate').value);
                
                if (startDate > endDate) {
                    document.getElementById('endDate').value = this.value;
                    currentFilter.endDate = new Date(this.value);
                    currentFilter.endDate.setHours(23, 59, 59, 999);
                }
            });
            
            document.getElementById('endDate').addEventListener('change', function() {
                const startDate = new Date(document.getElementById('startDate').value);
                const endDate = new Date(this.value);
                
                if (endDate < startDate) {
                    alert('ç»“æŸæ—¥æœŸä¸èƒ½æ—©äºå¼€å§‹æ—¥æœŸ');
                    this.value = document.getElementById('startDate').value;
                    currentFilter.endDate = new Date(this.value);
                    currentFilter.endDate.setHours(23, 59, 59, 999);
                }
            });
            
            // ç­›é€‰æŒ‰é’®äº‹ä»¶
            document.getElementById('applyDateFilterBtn').addEventListener('click', applyDateFilter);
            document.getElementById('resetDateFilterBtn').addEventListener('click', resetDateFilter);
            
            // æ“ä½œç±»å‹ç­›é€‰å˜æ›´äº‹ä»¶
            document.getElementById('logType').addEventListener('change', function() {
                loadOperationLogs();
            });
            
            // æ¸…é™¤æ—¥å¿—æŒ‰é’®äº‹ä»¶
            document.getElementById('clearLogsBtn').addEventListener('click', clearLogs);
            
            // å…¨é€‰æ—¥å¿—å¤é€‰æ¡†äº‹ä»¶
            document.getElementById('selectAllLogs').addEventListener('change', function() {
                const checkboxes = document.querySelectorAll('#logList .log-checkbox');
                checkboxes.forEach(checkbox => {
                    checkbox.checked = this.checked;
                });
            });
            
            // å…³é—­æ˜¨æ—¥ä»»åŠ¡é€šçŸ¥
            document.getElementById('closeNotification').addEventListener('click', function() {
                hideNotification('yesterdayTasksNotification');
            });
            
            // ç¼–è¾‘å»ºè®®å†…å®¹æ¨¡æ€æ¡†äº‹ä»¶
            document.getElementById('closeEditSuggestionModal').addEventListener('click', function() {
                hideModal('editSuggestionModal');
            });
            
            document.getElementById('cancelEditSuggestion').addEventListener('click', function() {
                hideModal('editSuggestionModal');
            });
            
            document.getElementById('saveEditSuggestion').addEventListener('click', function() {
                saveEditedSuggestion();
            });
            
            // å››è±¡é™æ ‡é¢˜ç‚¹å‡»äº‹ä»¶ - å±•å¼€/æŠ˜å ä»»åŠ¡åˆ—è¡¨
            document.querySelectorAll('.quadrant-header').forEach(header => {
                header.addEventListener('click', function() {
                    const quadrant = this.dataset.quadrant;
                    const container = document.getElementById(`taskContainer${quadrant}`);
                    const toggleIcon = this.querySelector('.toggle-icon');
                    
                    if (container.style.display === 'none') {
                        container.style.display = 'block';
                        toggleIcon.textContent = 'â–¼';
                    } else {
                        container.style.display = 'none';
                        toggleIcon.textContent = 'â–¶';
                    }
                });
            });
            
            // å›¾ç‰‡ç®¡ç†ç›¸å…³äº‹ä»¶
            document.getElementById('uploadBtn').addEventListener('click', function() {
                document.getElementById('fileInput').click();
            });
            
            document.getElementById('fileInput').addEventListener('change', function(e) {
                handleImageUpload(e.target.files);
            });
            
            document.getElementById('uploadArea').addEventListener('dragover', function(e) {
                e.preventDefault();
                this.classList.add('dragover');
            });
            
            document.getElementById('uploadArea').addEventListener('dragleave', function(e) {
                e.preventDefault();
                this.classList.remove('dragover');
            });
            
            document.getElementById('uploadArea').addEventListener('drop', function(e) {
                e.preventDefault();
                this.classList.remove('dragover');
                handleImageUpload(e.dataTransfer.files);
            });
            
            document.getElementById('imageSearchBtn').addEventListener('click', function() {
                searchImages();
            });
            
            document.getElementById('imageSearchInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    searchImages();
                }
            });
            
            document.getElementById('closeImageModal').addEventListener('click', function() {
                hideModal('imageModal');
            });
            
            // ç¼–è¾‘å›¾ç‰‡ä¿¡æ¯æ¨¡æ€æ¡†äº‹ä»¶
            document.getElementById('closeEditImageModal').addEventListener('click', function() {
                hideModal('editImageModal');
            });
            
            document.getElementById('cancelEditImage').addEventListener('click', function() {
                hideModal('editImageModal');
            });
            
            document.getElementById('saveEditImage').addEventListener('click', function() {
                saveEditedImage();
            });
            
            // åˆ—è¡¨è§†å›¾æ’åºæŒ‰é’®äº‹ä»¶
            document.querySelectorAll('.sort-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.sort-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    listSortMethod = this.dataset.sort;
                    renderListView();
                });
            });
            
            // è‡ªå®šä¹‰æ ‡ç­¾ç›¸å…³äº‹ä»¶
            document.getElementById('addTagBtn').addEventListener('click', function() {
                openEditTagModal();
            });
            
            document.getElementById('addImageTagBtn').addEventListener('click', function() {
                openEditTagModal();
            });
            
            document.getElementById('closeEditTagModal').addEventListener('click', function() {
                hideModal('editTagModal');
            });
            
            document.getElementById('cancelEditTag').addEventListener('click', function() {
                hideModal('editTagModal');
            });
            
            document.getElementById('saveEditTag').addEventListener('click', function() {
                saveEditedTag();
            });
            
            // æ–‡ä»¶å¤¹ç›¸å…³äº‹ä»¶
            document.getElementById('createFolderBtn').addEventListener('click', function() {
                openEditFolderModal();
            });
            
            document.getElementById('closeEditFolderModal').addEventListener('click', function() {
                hideModal('editFolderModal');
            });
            
            document.getElementById('cancelEditFolder').addEventListener('click', function() {
                hideModal('editFolderModal');
            });
            
            document.getElementById('saveEditFolder').addEventListener('click', function() {
                saveEditedFolder();
            });
            
            // åŠ è½½ä¿å­˜çš„æ•°æ®
            loadViewPreference();
            
            // åˆå§‹åŒ–æ“ä½œè®°å½•
            loadOperationLogs();
            
            // è®¾ç½®ä¸æ´»åŠ¨è®¡æ—¶å™¨
            setupInactivityTimer();
            
            // æ·»åŠ ç”¨æˆ·æ´»åŠ¨ç›‘å¬å™¨
            document.addEventListener('mousemove', resetInactivityTimer);
            document.addEventListener('keypress', resetInactivityTimer);
            document.addEventListener('click', resetInactivityTimer);
            document.addEventListener('scroll', resetInactivityTimer);
            
            // ESCé”®é€€å‡ºç™»å½•
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    // å¦‚æœä»»ä½•æ¨¡æ€æ¡†æ˜¯æ‰“å¼€çš„ï¼Œå…ˆå…³é—­å®ƒ
                    if (document.querySelector('.modal.show')) {
                        const modalId = document.querySelector('.modal.show').id;
                        hideModal(modalId);
                        e.preventDefault();
                    } else if (document.getElementById('yesterdayTasksNotification').classList.contains('show')) {
                        hideNotification('yesterdayTasksNotification');
                        e.preventDefault();
                    } else if (document.getElementById('appContainer').style.display === 'block') {
                        logout();
                        e.preventDefault();
                    }
                }
                
                // Enteré”®ç¡®è®¤æ“ä½œ
                if (e.key === 'Enter') {
                    const activeElement = document.activeElement;
                    if (activeElement.classList.contains('modal-btn-primary')) {
                        activeElement.click();
                        e.preventDefault();
                    }
                }
            });
            
            // åˆå§‹åŒ–æ‹–æ‹½åŠŸèƒ½
            initDragAndDrop();
            
            // æ–°å¢ï¼šç²˜è´´å›¾ç‰‡åŠŸèƒ½
            document.addEventListener('paste', function(e) {
                // åªæœ‰åœ¨å›¾ç‰‡ç®¡ç†è§†å›¾æ‰å¤„ç†ç²˜è´´äº‹ä»¶
                if (currentView !== 'images') return;
                
                const items = e.clipboardData.items;
                if (!items) return;
                
                let imageFound = false;
                
                for (let i = 0; i < items.length; i++) {
                    if (items[i].type.indexOf('image') !== -1) {
                        imageFound = true;
                        const blob = items[i].getAsFile();
                        const file = new File([blob], `pasted-image-${Date.now()}.png`, { type: 'image/png' });
                        
                        // æ˜¾ç¤ºç²˜è´´æç¤º
                        showPasteHint();
                        
                        // å¤„ç†ä¸Šä¼ 
                        handleImageUpload([file]);
                    }
                }
            });
        });
        
        // æ˜¾ç¤ºç²˜è´´æç¤º
        function showPasteHint() {
            const hint = document.getElementById('pasteHint');
            hint.style.display = 'block';
            setTimeout(() => {
                hint.style.display = 'none';
            }, 3000);
        }
        
        // åˆå§‹åŒ–å›¾ç‰‡æ‡’åŠ è½½
        function initImageLazyLoading() {
            // æ£€æŸ¥æµè§ˆå™¨æ˜¯å¦æ”¯æŒ Intersection Observer API
            if ('IntersectionObserver' in window) {
                imageObserver = new IntersectionObserver((entries, observer) => {
                    entries.forEach(entry => {
                        if (entry.isIntersecting) {
                            const img = entry.target;
                            img.src = img.dataset.src;
                            img.classList.remove('lazy');
                            imageObserver.unobserve(img);
                        }
                    });
                }, {
                    rootMargin: '50px 0px', // æå‰50pxå¼€å§‹åŠ è½½
                    threshold: 0.01
                });
            }
        }
        
        // åˆ›å»ºç©ºä»»åŠ¡å¹¶æ‰“å¼€ç¼–è¾‘æ¨¡æ€æ¡†
        function createEmptyTask(quadrant) {
            // åˆ›å»ºæ–°ä»»åŠ¡
            const newTask = {
                text: '',
                priority: currentPriority,
                completed: false,
                quadrant: quadrant,
                category: getCategoryByPriority(currentPriority),
                createdAt: new Date().toISOString()
            };
            
            // ä¿å­˜åˆ°æ•°æ®åº“
            saveTaskToDatabase(newTask).then(savedTask => {
                if (savedTask) {
                    tasks.push(savedTask);
                    renderTask(savedTask);
                    
                    // æ‰“å¼€ç¼–è¾‘æ¨¡æ€æ¡†
                    openEditModal(savedTask.id);
                    
                    // è®°å½•æ“ä½œæ—¥å¿—
                    logOperation('add', `åˆ›å»ºæ–°ä»»åŠ¡ï¼ˆè±¡é™ï¼š${getQuadrantName(quadrant)}ï¼‰`);
                    
                    updateTaskStats();
                }
            });
        }
        
        // å›¾ç‰‡ç®¡ç†åŠŸèƒ½
        function handleImageUpload(files) {
            if (!files || files.length === 0) return;
            
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                if (!file.type.match('image.*')) {
                    alert('åªèƒ½ä¸Šä¼ å›¾ç‰‡æ–‡ä»¶');
                    continue;
                }
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    const imageData = e.target.result;
                    
                    // åˆ›å»ºå›¾ç‰‡å¯¹è±¡
                    const newImage = {
                        name: file.name,
                        data: imageData,
                        description: '',
                        category: 'all',
                        folder: 'default',
                        size: file.size,
                        uploadedAt: new Date().toISOString()
                    };
                    
                    // ä¿å­˜åˆ°æ•°æ®åº“
                    saveImageToDatabase(newImage).then(savedImage => {
                        if (savedImage) {
                            images.push(savedImage);
                            renderImage(savedImage);
                            
                            // è®°å½•æ“ä½œæ—¥å¿—
                            logOperation('system', `ä¸Šä¼ å›¾ç‰‡ï¼š${file.name}`);
                        }
                    });
                };
                
                reader.readAsDataURL(file);
            }
            
            // æ¸…ç©ºæ–‡ä»¶è¾“å…¥
            document.getElementById('fileInput').value = '';
        }
        
        function renderImage(image) {
            const imagesGrid = document.getElementById('imagesGrid');
            
            const imageCard = document.createElement('div');
            imageCard.className = 'image-card';
            imageCard.dataset.id = image.id;
            imageCard.dataset.category = image.category;
            
            const uploadDate = new Date(image.uploadedAt).toLocaleDateString();
            const categoryText = getCategoryNameById(image.category);
            const sizeText = formatFileSize(image.size);
            
            // ä½¿ç”¨ data-src å±æ€§å­˜å‚¨å›¾ç‰‡URLï¼Œå®ç°æ‡’åŠ è½½
            imageCard.innerHTML = `
                <div class="image-container">
                    <img data-src="${image.data}" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org2000/svg' width='200' height='150' viewBox='0 0 200 150'%3E%3Crect width='200' height='150' fill='%23f0f0f0'/%3E%3Ctext x='50%25' y='50%25' dominant-baseline='middle' text-anchor='middle' font-family='Arial' font-size='14' fill='%23999'%3EåŠ è½½ä¸­...%3C/text%3E%3C/svg%3E" alt="${image.name}" class="lazy" loading="lazy">
                </div>
                <div class="image-info">
                    <div class="image-title">${image.name}</div>
                    <div class="image-date">${uploadDate}</div>
                    <div class="image-size">${sizeText}</div>
                    <div class="image-category">${categoryText}</div>
                    <div class="image-actions">
                        <button class="image-action view-image-btn">ğŸ‘ï¸</button>
                        <button class="image-action edit-image-btn">âœï¸</button>
                        <button class="image-action delete-image-btn">ğŸ—‘ï¸</button>
                    </div>
                </div>
            `;
            
            // æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
            const viewBtn = imageCard.querySelector('.view-image-btn');
            viewBtn.addEventListener('click', function() {
                viewImage(image);
            });
            
            const editBtn = imageCard.querySelector('.edit-image-btn');
            editBtn.addEventListener('click', function() {
                openEditImageModal(image.id);
            });
            
            const deleteBtn = imageCard.querySelector('.delete-image-btn');
            deleteBtn.addEventListener('click', function() {
                deleteImage(image.id);
            });
            
            imagesGrid.appendChild(imageCard);
            
            // å¦‚æœæ”¯æŒ Intersection Observerï¼Œåˆ™è§‚å¯Ÿå›¾ç‰‡è¿›è¡Œæ‡’åŠ è½½
            const img = imageCard.querySelector('img');
            if (imageObserver) {
                imageObserver.observe(img);
            } else {
                // å¦‚æœä¸æ”¯æŒï¼Œç›´æ¥åŠ è½½å›¾ç‰‡
                img.src = img.dataset.src;
                img.classList.remove('lazy');
            }
        }
        
        function viewImage(image) {
            document.getElementById('modalImage').src = image.data;
            document.getElementById('modalImage').alt = image.name;
            showModal('imageModal');
        }
        
        function openEditImageModal(imageId) {
            const image = images.find(img => img.id === imageId);
            if (image) {
                editingImageId = imageId;
                document.getElementById('editImageName').value = image.name;
                document.getElementById('editImageDescription').value = image.description || '';
                
                // æ›´æ–°åˆ†ç±»é€‰æ‹©å™¨
                updateCategorySelectors();
                document.getElementById('editImageCategory').value = image.category;
                
                // æ›´æ–°æ–‡ä»¶å¤¹é€‰æ‹©å™¨
                updateFolderSelectors();
                document.getElementById('editImageFolder').value = image.folder || 'default';
                
                showModal('editImageModal');
            }
        }
        
        function saveEditedImage() {
            if (editingImageId !== null) {
                const image = images.find(img => img.id === editingImageId);
                if (image) {
                    const oldName = image.name;
                    const oldCategory = image.category;
                    const oldFolder = image.folder;
                    
                    image.name = document.getElementById('editImageName').value;
                    image.description = document.getElementById('editImageDescription').value;
                    image.category = document.getElementById('editImageCategory').value;
                    image.folder = document.getElementById('editImageFolder').value;
                    
                    // ä¿å­˜åˆ°æ•°æ®åº“
                    saveImageToDatabase(image).then(savedImage => {
                        if (savedImage) {
                            // è®°å½•æ“ä½œæ—¥å¿—
                            let changes = [];
                            if (oldName !== image.name) changes.push(`åç§°ä»"${oldName}"ä¿®æ”¹ä¸º"${image.name}"`);
                            if (oldCategory !== image.category) changes.push(`åˆ†ç±»ä»"${getCategoryNameById(oldCategory)}"ä¿®æ”¹ä¸º"${getCategoryNameById(image.category)}"`);
                            if (oldFolder !== image.folder) changes.push(`æ–‡ä»¶å¤¹ä»"${getFolderNameById(oldFolder)}"ä¿®æ”¹ä¸º"${getFolderNameById(image.folder)}"`);
                            
                            if (changes.length > 0) {
                                logOperation('edit', `ç¼–è¾‘å›¾ç‰‡ä¿¡æ¯ï¼š${changes.join('ï¼Œ')}`);
                            }
                            
                            // é‡æ–°æ¸²æŸ“å›¾ç‰‡
                            document.querySelector(`.image-card[data-id="${editingImageId}"]`).remove();
                            renderImage(image);
                            
                            // åº”ç”¨åˆ†ç±»ç­›é€‰
                            filterImagesByCategory();
                            
                            hideModal('editImageModal');
                            editingImageId = null;
                        }
                    });
                }
            }
        }
        
        function deleteImage(imageId) {
            if (confirm('ç¡®å®šè¦åˆ é™¤è¿™å¼ å›¾ç‰‡å—ï¼Ÿ')) {
                const imageIndex = images.findIndex(img => img.id === imageId);
                if (imageIndex !== -1) {
                    const image = images[imageIndex];
                    
                    // ä»æ•°æ®åº“åˆ é™¤
                    deleteImageFromDatabase(imageId).then(success => {
                        if (success) {
                            // è®°å½•æ“ä½œæ—¥å¿—
                            logOperation('delete', `åˆ é™¤å›¾ç‰‡ï¼š${image.name}`);
                            
                            images.splice(imageIndex, 1);
                            document.querySelector(`.image-card[data-id="${imageId}"]`).remove();
                        }
                    });
                }
            }
        }
        
        function searchImages() {
            const searchText = document.getElementById('imageSearchInput').value.toLowerCase();
            const imageCards = document.querySelectorAll('.image-card');
            
            imageCards.forEach(card => {
                const imageName = card.querySelector('.image-title').textContent.toLowerCase();
                const imageCategory = card.dataset.category;
                
                const matchesSearch = imageName.includes(searchText);
                const matchesCategory = imageCategoryFilter === 'all' || imageCategory === imageCategoryFilter;
                
                if (matchesSearch && matchesCategory) {
                    card.style.display = 'block';
                } else {
                    card.style.display = 'none';
                }
            });
        }
        
        function filterImagesByCategory() {
            const imageCards = document.querySelectorAll('.image-card');
            const searchText = document.getElementById('imageSearchInput').value.toLowerCase();
            
            imageCards.forEach(card => {
                const imageName = card.querySelector('.image-title').textContent.toLowerCase();
                const imageCategory = card.dataset.category;
                
                const matchesSearch = imageName.includes(searchText);
                const matchesCategory = imageCategoryFilter === 'all' || imageCategory === imageCategoryFilter;
                
                if (matchesSearch && matchesCategory) {
                    card.style.display = 'block';
                } else {
                    card.style.display = 'none';
                }
            });
        }
        
        // æ–‡ä»¶å¤¹ç®¡ç†åŠŸèƒ½
        function loadFolders() {
            const savedFolders = localStorage.getItem('folders');
            if (savedFolders) {
                folders = JSON.parse(savedFolders);
            } else {
                // åˆå§‹åŒ–é»˜è®¤æ–‡ä»¶å¤¹
                folders = [
                    {
                        id: 'default',
                        name: 'é»˜è®¤æ–‡ä»¶å¤¹',
                        description: 'ç³»ç»Ÿé»˜è®¤æ–‡ä»¶å¤¹',
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString(),
                        imageCount: 0,
                        totalSize: 0
                    }
                ];
                saveFolders();
            }
            
            renderFolders();
        }
        
        function saveFolders() {
            localStorage.setItem('folders', JSON.stringify(folders));
        }
        
        function renderFolders() {
            const foldersGrid = document.getElementById('foldersGrid');
            foldersGrid.innerHTML = '';
            
            if (folders.length === 0) {
                foldersGrid.innerHTML = '<div class="empty-state">æš‚æ— æ–‡ä»¶å¤¹</div>';
                return;
            }
            
            folders.forEach(folder => {
                const folderCard = document.createElement('div');
                folderCard.className = 'folder-card';
                folderCard.dataset.id = folder.id;
                
                const createdDate = new Date(folder.createdAt).toLocaleString();
                const updatedDate = new Date(folder.updatedAt).toLocaleString();
                const sizeText = formatFileSize(folder.totalSize);
                
                folderCard.innerHTML = `
                    <div class="folder-header">
                        <h4 class="folder-name">${folder.name}</h4>
                        <div class="folder-actions">
                            <button class="folder-action edit-folder-btn">âœï¸</button>
                            <button class="folder-action delete-folder-btn">ğŸ—‘ï¸</button>
                        </div>
                    </div>
                    <div class="folder-info">
                        <div class="folder-info-item">åˆ›å»ºæ—¶é—´: ${createdDate}</div>
                        <div class="folder-info-item">æœ€åä¿®æ”¹: ${updatedDate}</div>
                        <div class="folder-info-item">å›¾ç‰‡æ•°é‡: ${folder.imageCount} å¼ </div>
                        <div class="folder-info-item">æ€»å¤§å°: ${sizeText}</div>
                    </div>
                `;
                
                // æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
                const editBtn = folderCard.querySelector('.edit-folder-btn');
                editBtn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    openEditFolderModal(folder.id);
                });
                
                const deleteBtn = folderCard.querySelector('.delete-folder-btn');
                deleteBtn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    deleteFolder(folder.id);
                });
                
                folderCard.addEventListener('click', function() {
                    // åˆ‡æ¢åˆ°å›¾ç‰‡ç®¡ç†è§†å›¾å¹¶ç­›é€‰è¯¥æ–‡ä»¶å¤¹çš„å›¾ç‰‡
                    currentView = 'images';
                    document.querySelectorAll('.tab').forEach(tab => {
                        tab.classList.remove('active');
                        if (tab.dataset.view === 'images') {
                            tab.classList.add('active');
                        }
                    });
                    switchView('images');
                    
                    // ç­›é€‰è¯¥æ–‡ä»¶å¤¹çš„å›¾ç‰‡
                    imageCategoryFilter = folder.id;
                    document.querySelectorAll('#imageTagsContainer .custom-tag').forEach(tag => {
                        tag.classList.remove('active');
                        if (tag.dataset.category === folder.id) {
                            tag.classList.add('active');
                        }
                    });
                    filterImagesByCategory();
                });
                
                foldersGrid.appendChild(folderCard);
            });
        }
        
        function openEditFolderModal(folderId = null) {
            editingFolderId = folderId;
            
            if (folderId) {
                // ç¼–è¾‘ç°æœ‰æ–‡ä»¶å¤¹
                const folder = folders.find(f => f.id === folderId);
                if (folder) {
                    document.getElementById('editFolderModalTitle').textContent = 'ç¼–è¾‘æ–‡ä»¶å¤¹';
                    document.getElementById('editFolderName').value = folder.name;
                    document.getElementById('editFolderDescription').value = folder.description || '';
                }
            } else {
                // åˆ›å»ºæ–°æ–‡ä»¶å¤¹
                document.getElementById('editFolderModalTitle').textContent = 'åˆ›å»ºæ–‡ä»¶å¤¹';
                document.getElementById('editFolderName').value = '';
                document.getElementById('editFolderDescription').value = '';
            }
            
            showModal('editFolderModal');
        }
        
        function saveEditedFolder() {
            const name = document.getElementById('editFolderName').value.trim();
            const description = document.getElementById('editFolderDescription').value.trim();
            
            if (!name) {
                alert('è¯·è¾“å…¥æ–‡ä»¶å¤¹åç§°');
                return;
            }
            
            if (editingFolderId) {
                // æ›´æ–°ç°æœ‰æ–‡ä»¶å¤¹
                const folderIndex = folders.findIndex(f => f.id === editingFolderId);
                if (folderIndex !== -1) {
                    folders[folderIndex].name = name;
                    folders[folderIndex].description = description;
                    folders[folderIndex].updatedAt = new Date().toISOString();
                }
            } else {
                // åˆ›å»ºæ–°æ–‡ä»¶å¤¹
                const newId = 'folder_' + Date.now();
                folders.push({
                    id: newId,
                    name: name,
                    description: description,
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString(),
                    imageCount: 0,
                    totalSize: 0
                });
            }
            
            saveFolders();
            renderFolders();
            updateFolderSelectors();
            hideModal('editFolderModal');
            
            // è®°å½•æ“ä½œæ—¥å¿—
            logOperation('system', `${editingFolderId ? 'ç¼–è¾‘' : 'åˆ›å»º'}æ–‡ä»¶å¤¹ï¼š"${name}"`);
        }
        
        function deleteFolder(folderId) {
            if (folderId === 'default') {
                alert('é»˜è®¤æ–‡ä»¶å¤¹ä¸èƒ½åˆ é™¤');
                return;
            }
            
            const folder = folders.find(f => f.id === folderId);
            if (!folder) return;
            
            const confirmDelete = confirm(`ç¡®å®šè¦åˆ é™¤æ–‡ä»¶å¤¹"${folder.name}"å—ï¼Ÿ`);
            if (!confirmDelete) return;
            
            const deleteImages = confirm('æ˜¯å¦åŒæ—¶åˆ é™¤æ–‡ä»¶å¤¹å†…çš„æ‰€æœ‰å›¾ç‰‡ï¼Ÿ');
            
            if (deleteImages) {
                // åˆ é™¤æ–‡ä»¶å¤¹åŠå…¶å†…éƒ¨å›¾ç‰‡
                const folderImages = images.filter(img => img.folder === folderId);
                folderImages.forEach(img => {
                    deleteImageFromDatabase(img.id);
                });
                
                // ä»å›¾ç‰‡æ•°ç»„ä¸­ç§»é™¤
                images = images.filter(img => img.folder !== folderId);
                
                // é‡æ–°æ¸²æŸ“å›¾ç‰‡ç½‘æ ¼
                document.getElementById('imagesGrid').innerHTML = '';
                images.forEach(img => renderImage(img));
                
                logOperation('delete', `åˆ é™¤æ–‡ä»¶å¤¹"${folder.name}"åŠå…¶å†…éƒ¨${folderImages.length}å¼ å›¾ç‰‡`);
            } else {
                // ä»…åˆ é™¤æ–‡ä»¶å¤¹ï¼Œå°†å›¾ç‰‡ç§»åŠ¨åˆ°é»˜è®¤æ–‡ä»¶å¤¹
                images.forEach(img => {
                    if (img.folder === folderId) {
                        img.folder = 'default';
                        saveImageToDatabase(img);
                    }
                });
                
                logOperation('delete', `åˆ é™¤æ–‡ä»¶å¤¹"${folder.name}"ï¼Œå›¾ç‰‡å·²ç§»åŠ¨åˆ°é»˜è®¤æ–‡ä»¶å¤¹`);
            }
            
            // ä»æ–‡ä»¶å¤¹æ•°ç»„ä¸­ç§»é™¤
            folders = folders.filter(f => f.id !== folderId);
            saveFolders();
            renderFolders();
            updateFolderSelectors();
        }
        
        function getFolderNameById(folderId) {
            const folder = folders.find(f => f.id === folderId);
            return folder ? folder.name : 'é»˜è®¤æ–‡ä»¶å¤¹';
        }
        
        function updateFolderSelectors() {
            // æ›´æ–°å›¾ç‰‡ç¼–è¾‘æ¨¡æ€æ¡†çš„æ–‡ä»¶å¤¹é€‰æ‹©å™¨
            const imageFolderSelect = document.getElementById('editImageFolder');
            imageFolderSelect.innerHTML = '';
            
            folders.forEach(folder => {
                const option = document.createElement('option');
                option.value = folder.id;
                option.textContent = folder.name;
                imageFolderSelect.appendChild(option);
            });
        }
        
        // æ–‡ä»¶å¤§å°æ ¼å¼åŒ–å‡½æ•°
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
        
        // ä¿å­˜å›¾ç‰‡åˆ°æ•°æ®åº“
        async function saveImageToDatabase(image) {
            if (!supabase) return null;
            
            try {
                // å›¾ç‰‡å‹ç¼©å’Œä¼˜åŒ–
                const optimizedImageData = await optimizeImage(image.data);
                
                const imageData = {
                    name: image.name,
                    data: optimizedImageData,
                    description: image.description,
                    category: image.category,
                    folder: image.folder || 'default',
                    size: image.size || 0,
                    uploaded_at: image.uploadedAt
                };
                
                let result;
                if (image.id) {
                    // æ›´æ–°ç°æœ‰å›¾ç‰‡
                    result = await supabase
                        .from('images')
                        .update(imageData)
                        .eq('id', image.id);
                } else {
                    // åˆ›å»ºæ–°å›¾ç‰‡
                    result = await supabase
                        .from('images')
                        .insert([imageData])
                        .select();
                    
                    // è·å–æ–°åˆ›å»ºçš„å›¾ç‰‡ID
                    if (result.data && result.data.length > 0) {
                        image.id = result.data[0].id;
                    }
                }
                
                if (result.error) {
                    throw result.error;
                }
                
                showMessage('å›¾ç‰‡å·²ä¿å­˜åˆ°äº‘ç«¯', false);
                return image;
            } catch (error) {
                console.error('ä¿å­˜å›¾ç‰‡åˆ°æ•°æ®åº“å¤±è´¥:', error);
                showMessage('åŒæ­¥å›¾ç‰‡åˆ°æœåŠ¡å™¨å¤±è´¥', true);
                return null;
            }
        }
        
        // å›¾ç‰‡å‹ç¼©å’Œä¼˜åŒ–å‡½æ•°
        function optimizeImage(imageData) {
            return new Promise((resolve) => {
                // åˆ›å»ºä¸€ä¸ªä¸´æ—¶å›¾ç‰‡å…ƒç´ æ¥è·å–å›¾ç‰‡å°ºå¯¸
                const img = new Image();
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    
                    // è®¡ç®—å‹ç¼©åçš„å°ºå¯¸ï¼ˆæœ€å¤§å®½åº¦800pxï¼‰
                    let width = img.width;
                    let height = img.height;
                    const maxWidth = 800;
                    
                    if (width > maxWidth) {
                        height = (height * maxWidth) / width;
                        width = maxWidth;
                    }
                    
                    canvas.width = width;
                    canvas.height = height;
                    
                    // ç»˜åˆ¶å›¾ç‰‡åˆ°canvas
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    // å°è¯•è½¬æ¢ä¸ºWebPæ ¼å¼ï¼Œå¦‚æœä¸æ”¯æŒåˆ™ä½¿ç”¨JPEG
                    try {
                        // æ£€æŸ¥æµè§ˆå™¨æ˜¯å¦æ”¯æŒWebP
                        const supportsWebP = document.createElement('canvas').toDataURL('image/webp').indexOf('data:image/webp') === 0;
                        
                        if (supportsWebP) {
                            // ä½¿ç”¨WebPæ ¼å¼ï¼Œè´¨é‡80%
                            resolve(canvas.toDataURL('image/webp', 0.8));
                        } else {
                            // ä½¿ç”¨JPEGæ ¼å¼ï¼Œè´¨é‡80%
                            resolve(canvas.toDataURL('image/jpeg', 0.8));
                        }
                    } catch (e) {
                        // å¦‚æœè½¬æ¢å¤±è´¥ï¼Œè¿”å›åŸå§‹æ•°æ®
                        console.warn('å›¾ç‰‡æ ¼å¼è½¬æ¢å¤±è´¥ï¼Œä½¿ç”¨åŸå§‹æ ¼å¼:', e);
                        resolve(imageData);
                    }
                };
                
                img.onerror = function() {
                    // å¦‚æœå›¾ç‰‡åŠ è½½å¤±è´¥ï¼Œè¿”å›åŸå§‹æ•°æ®
                    console.warn('å›¾ç‰‡åŠ è½½å¤±è´¥ï¼Œä½¿ç”¨åŸå§‹æ•°æ®');
                    resolve(imageData);
                };
                
                img.src = imageData;
            });
        }
        
        // ä»æ•°æ®åº“åˆ é™¤å›¾ç‰‡
        async function deleteImageFromDatabase(imageId) {
            if (!supabase) return false;
            
            try {
                const { error } = await supabase
                    .from('images')
                    .delete()
                    .eq('id', imageId);
                
                if (error) {
                    throw error;
                }
                
                showMessage('å›¾ç‰‡å·²ä»äº‘ç«¯åˆ é™¤', false);
                return true;
            } catch (error) {
                console.error('ä»æ•°æ®åº“åˆ é™¤å›¾ç‰‡å¤±è´¥:', error);
                showMessage('ä»æœåŠ¡å™¨åˆ é™¤å›¾ç‰‡å¤±è´¥', true);
                return false;
            }
        }
        
        // ä»æ•°æ®åº“åŠ è½½å›¾ç‰‡
        async function loadImagesFromDatabase() {
            if (!supabase) return;
            
            try {
                const { data, error } = await supabase
                    .from('images')
                    .select('*')
                    .order('uploaded_at', { ascending: false });
                
                if (error) {
                    console.error('åŠ è½½å›¾ç‰‡å¤±è´¥:', error);
                    showMessage('ä»æœåŠ¡å™¨åŠ è½½å›¾ç‰‡å¤±è´¥', true);
                    return;
                }
                
                // æ¸…ç©ºç°æœ‰å›¾ç‰‡
                images = [];
                
                // å°†æ•°æ®åº“ä¸­çš„æ•°æ®è½¬æ¢ä¸ºåº”ç”¨æ ¼å¼
                if (data && data.length > 0) {
                    data.forEach(item => {
                        const image = {
                            id: item.id,
                            name: item.name,
                            data: item.data,
                            description: item.description,
                            category: item.category || 'all',
                            folder: item.folder || 'default',
                            size: item.size || 0,
                            uploadedAt: item.uploaded_at
                        };
                        images.push(image);
                    });
                    
                    // æ¸…ç©ºç°æœ‰å›¾ç‰‡ç½‘æ ¼
                    document.getElementById('imagesGrid').innerHTML = '';
                    
                    // é‡æ–°æ¸²æŸ“æ‰€æœ‰å›¾ç‰‡
                    images.forEach(image => {
                        renderImage(image);
                    });
                    
                    showMessage('å›¾ç‰‡å·²ä»æœåŠ¡å™¨åŠ è½½', false);
                }
            } catch (error) {
                console.error('åŠ è½½å›¾ç‰‡å¼‚å¸¸:', error);
                showMessage('åŠ è½½å›¾ç‰‡è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯', true);
            }
        }
        
        // åˆå§‹åŒ–Supabase
        function initSupabase() {
            try {
                if (window.supabaseConfig && window.supabaseConfig.SUPABASE_URL && window.supabaseConfig.SUPABASE_ANON_KEY) {
                    supabase = window.supabase.createClient(window.supabaseConfig.SUPABASE_URL, window.supabaseConfig.SUPABASE_ANON_KEY);
                    console.log('Supabaseåˆå§‹åŒ–æˆåŠŸ');
                    loadTasksFromDatabase();
                    loadLogsFromDatabase();
                    loadImagesFromDatabase();
                    loadCustomTagsFromDatabase(); // æ–°å¢ï¼šä»æ•°æ®åº“åŠ è½½æ ‡ç­¾
                } else {
                    console.warn('Supabaseé…ç½®æœªè®¾ç½®');
                    showMessage('æ•°æ®åº“è¿æ¥é…ç½®ç¼ºå¤±ï¼Œéƒ¨åˆ†åŠŸèƒ½å¯èƒ½æ— æ³•ä½¿ç”¨', true);
                }
            } catch (error) {
                console.error('Supabaseåˆå§‹åŒ–å¤±è´¥:', error);
                showMessage('è¿æ¥æœåŠ¡å™¨å¤±è´¥', true);
            }
        }
        
        // ä»æ•°æ®åº“åŠ è½½ä»»åŠ¡
        async function loadTasksFromDatabase() {
            if (!supabase) return;
            
            try {
                const { data, error } = await supabase
                    .from('tasks')
                    .select('*')
                    .order('created_at', { ascending: false });
                
                if (error) {
                    console.error('åŠ è½½ä»»åŠ¡å¤±è´¥:', error);
                    showMessage('ä»æœåŠ¡å™¨åŠ è½½ä»»åŠ¡å¤±è´¥', true);
                    return;
                }
                
                // æ¸…ç©ºç°æœ‰ä»»åŠ¡
                tasks = [];
                
                // å°†æ•°æ®åº“ä¸­çš„æ•°æ®è½¬æ¢ä¸ºåº”ç”¨æ ¼å¼
                if (data && data.length > 0) {
                    data.forEach(item => {
                        const task = {
                            id: item.id,
                            text: item.content,
                            priority: item.priority || 1,
                            completed: item.completed || false,
                            quadrant: item.quadrant || 1,
                            category: item.category || getCategoryByPriority(item.priority || 1),
                            createdAt: item.created_at
                        };
                        tasks.push(task);
                    });
                    
                    // æ¸…ç©ºç°æœ‰ä»»åŠ¡åˆ—è¡¨
                    document.querySelectorAll('.task-list').forEach(list => {
                        list.innerHTML = '';
                    });
                    
                    // é‡æ–°æ¸²æŸ“æ‰€æœ‰ä»»åŠ¡
                    tasks.forEach(task => {
                        renderTask(task);
                    });
                    
                    updateTaskStats();
                    showMessage('ä»»åŠ¡å·²ä»æœåŠ¡å™¨åŠ è½½', false);
                }
            } catch (error) {
                console.error('åŠ è½½ä»»åŠ¡å¼‚å¸¸:', error);
                showMessage('åŠ è½½è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯', true);
            }
        }
        
        // ä»æ•°æ®åº“åŠ è½½æ“ä½œæ—¥å¿—
        async function loadLogsFromDatabase() {
            if (!supabase) return;
            
            try {
                const { data, error } = await supabase
                    .from('operation_logs')
                    .select('*')
                    .order('timestamp', { ascending: false });
                
                if (error) {
                    console.error('åŠ è½½æ“ä½œæ—¥å¿—å¤±è´¥:', error);
                    showMessage('ä»æœåŠ¡å™¨åŠ è½½æ“ä½œæ—¥å¿—å¤±è´¥', true);
                    return;
                }
                
                // æ¸…ç©ºç°æœ‰æ“ä½œæ—¥å¿—
                operationLogs = [];
                
                // å°†æ•°æ®åº“ä¸­çš„æ•°æ®è½¬æ¢ä¸ºåº”ç”¨æ ¼å¼
                if (data && data.length > 0) {
                    data.forEach(item => {
                        const logEntry = {
                            timestamp: item.timestamp,
                            type: item.type,
                            content: item.content,
                            operator: item.operator
                        };
                        operationLogs.push(logEntry);
                    });
                    
                    showMessage('æ“ä½œæ—¥å¿—å·²ä»æœåŠ¡å™¨åŠ è½½', false);
                }
            } catch (error) {
                console.error('åŠ è½½æ“ä½œæ—¥å¿—å¼‚å¸¸:', error);
                showMessage('åŠ è½½æ“ä½œæ—¥å¿—è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯', true);
            }
        }
        
        // å°†ä»»åŠ¡ä¿å­˜åˆ°æ•°æ®åº“
        async function saveTaskToDatabase(task) {
            if (!supabase) return null;
            
            try {
                const taskData = {
                    content: task.text,
                    priority: task.priority,
                    completed: task.completed,
                    quadrant: task.quadrant,
                    category: task.category,
                    created_at: task.createdAt
                };
                
                let result;
                if (task.id) {
                    // æ›´æ–°ç°æœ‰ä»»åŠ¡
                    result = await supabase
                        .from('tasks')
                        .update(taskData)
                        .eq('id', task.id)
                        .select();
                } else {
                    // åˆ›å»ºæ–°ä»»åŠ¡
                    result = await supabase
                        .from('tasks')
                        .insert([taskData])
                        .select();
                    
                    // è·å–æ–°åˆ›å»ºçš„ä»»åŠ¡ID
                    if (result.data && result.data.length > 0) {
                        task.id = result.data[0].id;
                    }
                }
                
                if (result.error) {
                    throw result.error;
                }
                
                showMessage('ä»»åŠ¡å·²ä¿å­˜åˆ°äº‘ç«¯', false);
                return task;
            } catch (error) {
                console.error('ä¿å­˜ä»»åŠ¡åˆ°æ•°æ®åº“å¤±è´¥:', error);
                showMessage('åŒæ­¥åˆ°æœåŠ¡å™¨å¤±è´¥', true);
                return null;
            }
        }
        
        // æ›´æ–°æ•°æ®åº“ä¸­çš„ä»»åŠ¡
        async function updateTaskInDatabase(task) {
            return await saveTaskToDatabase(task);
        }
        
        // ä»æ•°æ®åº“åˆ é™¤ä»»åŠ¡
        async function deleteTaskFromDatabase(taskId) {
            if (!supabase) return false;
            
            try {
                const { error } = await supabase
                    .from('tasks')
                    .delete()
                    .eq('id', taskId);
                
                if (error) {
                    throw error;
                }
                
                showMessage('ä»»åŠ¡å·²ä»äº‘ç«¯åˆ é™¤', false);
                return true;
            } catch (error) {
                console.error('ä»æ•°æ®åº“åˆ é™¤ä»»åŠ¡å¤±è´¥:', error);
                showMessage('ä»æœåŠ¡å™¨åˆ é™¤ä»»åŠ¡å¤±è´¥', true);
                return false;
            }
        }
        
        // ä¿å­˜æ“ä½œæ—¥å¿—åˆ°æ•°æ®åº“
        async function saveLogToDatabase(logEntry) {
            if (!supabase) return false;
            
            try {
                const logData = {
                    timestamp: logEntry.timestamp,
                    type: logEntry.type,
                    content: logEntry.content,
                    operator: logEntry.operator
                };
                
                const { error } = await supabase
                    .from('operation_logs')
                    .insert([logData]);
                
                if (error) {
                    throw error;
                }
                
                return true;
            } catch (error) {
                console.error('ä¿å­˜æ“ä½œæ—¥å¿—åˆ°æ•°æ®åº“å¤±è´¥:', error);
                return false;
            }
        }
        
        // æ˜¾ç¤ºæ¶ˆæ¯
        function showMessage(text, isError = false) {
            const message = document.getElementById('message');
            message.textContent = text;
            message.className = isError ? 'error' : 'success';
            message.style.display = 'block';
            
            setTimeout(() => {
                message.style.display = 'none';
            }, 3000);
        }
        
        // æ˜¾ç¤ºæ¨¡æ€æ¡†
        function showModal(modalId) {
            const modal = document.getElementById(modalId);
            modal.style.display = 'flex';
            setTimeout(() => {
                modal.classList.add('show');
            }, 10);
        }
        
        // éšè—æ¨¡æ€æ¡†
        function hideModal(modalId) {
            const modal = document.getElementById(modalId);
            modal.classList.remove('show');
            setTimeout(() => {
                modal.style.display = 'none';
            }, 300);
        }
        
        // æ˜¾ç¤ºé€šçŸ¥
        function showNotification(notificationId) {
            const notification = document.getElementById(notificationId);
            notification.classList.add('show');
        }
        
        // éšè—é€šçŸ¥
        function hideNotification(notificationId) {
            const notification = document.getElementById(notificationId);
            notification.classList.remove('show');
        }
        
        // åˆå§‹åŒ–æ‹–æ‹½åŠŸèƒ½
        function initDragAndDrop() {
            // ä¸ºæ¯ä¸ªè±¡é™çš„ä»»åŠ¡åˆ—è¡¨åˆå§‹åŒ–Sortable
            for (let i = 1; i <= 4; i++) {
                new Sortable(document.getElementById(`quadrant${i}`), {
                    animation: 150,
                    ghostClass: 'drag-over',
                    dragClass: 'dragging',
                    group: 'tasks',
                    onEnd: function(evt) {
                        const taskId = parseInt(evt.item.dataset.id);
                        const newQuadrant = parseInt(evt.to.id.replace('quadrant', ''));
                        const task = tasks.find(t => t.id === taskId);
                        
                        if (task && task.quadrant !== newQuadrant) {
                            const oldQuadrant = task.quadrant;
                            task.quadrant = newQuadrant;
                            
                            // æ›´æ–°ä¼˜å…ˆçº§
                            if (newQuadrant === 1) task.priority = 1;
                            else if (newQuadrant === 2) task.priority = 2;
                            else if (newQuadrant === 3) task.priority = 3;
                            else task.priority = 4;
                            
                            // æ›´æ–°åˆ†ç±»
                            task.category = getCategoryByPriority(task.priority);
                            
                            // æ›´æ–°æ•°æ®åº“
                            updateTaskInDatabase(task);
                            
                            // è®°å½•æ“ä½œæ—¥å¿—
                            logOperation('edit', `å°†ä»»åŠ¡"${task.text}"ä»${getQuadrantName(oldQuadrant)}ç§»åŠ¨åˆ°${getQuadrantName(newQuadrant)}`);
                            
                            updateTaskStats();
                        }
                    }
                });
            }
        }
        
        // ç­‰å¾…Chart.jsåŠ è½½
        function waitForChartJS() {
            return new Promise((resolve, reject) => {
                if (typeof Chart !== 'undefined') {
                    resolve();
                    return;
                }
                
                let attempts = 0;
                const maxAttempts = 10;
                const interval = setInterval(() => {
                    attempts++;
                    if (typeof Chart !== 'undefined') {
                        clearInterval(interval);
                        resolve();
                    } else if (attempts >= maxAttempts) {
                        clearInterval(interval);
                        reject(new Error('Chart.jsåŠ è½½è¶…æ—¶'));
                    }
                }, 100);
            });
        }
        
        // è®¾ç½®ä¸æ´»åŠ¨è®¡æ—¶å™¨
        function setupInactivityTimer() {
            resetInactivityTimer();
        }
        
        // é‡ç½®ä¸æ´»åŠ¨è®¡æ—¶å™¨
        function resetInactivityTimer() {
            clearTimeout(inactivityTimer);
            inactivityTimer = setTimeout(logout, INACTIVITY_TIMEOUT);
        }
        
        // æ£€æŸ¥ç™»å½•çŠ¶æ€
        function checkLoginStatus() {
            // æ¯æ¬¡æ‰“å¼€ç½‘é¡µéƒ½æ˜¾ç¤ºç™»å½•ç•Œé¢
            document.getElementById('appContainer').style.display = 'none';
            document.getElementById('loginContainer').style.display = 'flex';
            document.getElementById('password').value = ''; // æ¸…ç©ºå¯†ç è¾“å…¥æ¡†
        }
        
        // æ£€æŸ¥æ˜¯å¦æ˜¯æ–°çš„æ—¥æœŸ
        function checkNewDay() {
            const lastAccessDate = localStorage.getItem('lastAccessDate');
            const currentDate = new Date().toISOString().split('T')[0];
            
            if (lastAccessDate !== currentDate) {
                // è·å–æ˜¨å¤©æœªå®Œæˆçš„ä»»åŠ¡
                const yesterdayUncompleted = tasks.filter(task => !task.completed);
                yesterdayUncompletedTasks = [...yesterdayUncompleted];
                
                // æ˜¾ç¤ºæ˜¨æ—¥æœªå®Œæˆä»»åŠ¡é€šçŸ¥
                if (yesterdayUncompleted.length > 0) {
                    showYesterdayTasksNotification(yesterdayUncompleted);
                }
                
                // å°†å½“å‰å·²å®Œæˆä»»åŠ¡ç§»åŠ¨åˆ°å·²åˆ é™¤åˆ—è¡¨
                tasks.forEach(task => {
                    if (task.completed) {
                        const deletedTask = {
                            ...task,
                            deletedAt: new Date().toISOString(),
                            isSystemDeleted: true
                        };
                        deletedTasks.push(deletedTask);
                        
                        // ä»æ•°æ®åº“åˆ é™¤å·²å®Œæˆçš„ä»»åŠ¡
                        if (supabase) {
                            deleteTaskFromDatabase(task.id);
                        }
                    }
                });
                
                // ä¿ç•™æœªå®Œæˆçš„ä»»åŠ¡
                tasks = tasks.filter(task => !task.completed);
                
                localStorage.setItem('lastAccessDate', currentDate);
                
                // æ¸…ç©ºç•Œé¢æ˜¾ç¤ºå¹¶é‡æ–°æ¸²æŸ“æœªå®Œæˆçš„ä»»åŠ¡
                document.querySelectorAll('.task-list').forEach(list => {
                    list.innerHTML = '';
                });
                document.getElementById('listTasks').innerHTML = '';
                
                // é‡æ–°æ¸²æŸ“æœªå®Œæˆçš„ä»»åŠ¡
                tasks.forEach(task => {
                    renderTask(task);
                });
                
                updateTaskStats();
                
                // è®°å½•æ“ä½œæ—¥å¿—
                logOperation('system', `æ–°çš„ä¸€å¤©å¼€å§‹ï¼Œå·²æ¸…ç©ºå·²å®Œæˆä»»åŠ¡ï¼ˆ${currentDate}ï¼‰ï¼Œä¿ç•™${tasks.length}é¡¹æœªå®Œæˆä»»åŠ¡`);
            }
        }
        
        // æ˜¾ç¤ºæ˜¨æ—¥æœªå®Œæˆä»»åŠ¡é€šçŸ¥
        function showYesterdayTasksNotification(tasks) {
            const listContainer = document.getElementById('yesterdayTasksList');
            listContainer.innerHTML = '';
            
            tasks.forEach(task => {
                const item = document.createElement('div');
                item.className = 'yesterday-task-item';
                item.innerHTML = `
                    <div><strong>${task.text}</strong></div>
                    <div>ä¼˜å…ˆçº§: ${['ç´§æ€¥é‡è¦', 'é‡è¦', 'ç´§æ€¥', 'æ™®é€š'][task.priority - 1]} | åˆ†ç±»: ${task.category}</div>
                `;
                listContainer.appendChild(item);
            });
            
            showNotification('yesterdayTasksNotification');
        }
        
        // ç™»å½•æˆåŠŸ
        function loginSuccess() {
            localStorage.setItem('isLoggedIn', 'true');
            localStorage.setItem('lastAccessDate', new Date().toISOString().split('T')[0]);
            document.getElementById('loginContainer').style.display = 'none';
            document.getElementById('appContainer').style.display = 'block';
            document.getElementById('password').value = ''; // æ¸…ç©ºå¯†ç è¾“å…¥æ¡†
            
            // æ£€æŸ¥æ˜¯å¦æ˜¯æ–°çš„æ—¥æœŸ
            checkNewDay();
            
            // é‡ç½®ä¸æ´»åŠ¨è®¡æ—¶å™¨
            resetInactivityTimer();
            
            // è®°å½•æ“ä½œæ—¥å¿—
            logOperation('system', 'ç”¨æˆ·ç™»å½•ç³»ç»Ÿ');
        }
        
        // é€€å‡ºç™»å½•
        function logout() {
            localStorage.removeItem('isLoggedIn');
            document.getElementById('appContainer').style.display = 'none';
            document.getElementById('loginContainer').style.display = 'flex';
            document.getElementById('password').value = ''; // æ¸…ç©ºå¯†ç è¾“å…¥æ¡†
            
            // è®°å½•æ“ä½œæ—¥å¿—
            logOperation('system', 'ç”¨æˆ·é€€å‡ºç³»ç»Ÿ');
        }
        
        // æ›´æ–°å½“å‰æ—¥æœŸ
        function updateCurrentDate() {
            const now = new Date();
            const options = { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' };
            document.getElementById('currentDate').textContent = now.toLocaleDateString('zh-CN', options);
            
            // è®¾ç½®æ—¥æœŸé€‰æ‹©å™¨é»˜è®¤å€¼
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('startDate').value = today;
            document.getElementById('endDate').value = today;
            
            // åˆå§‹åŒ–ç­›é€‰çŠ¶æ€
            currentFilter.startDate = new Date(today);
            currentFilter.endDate = new Date(today);
            currentFilter.endDate.setHours(23, 59, 59, 999);
        }
        
        // åˆ‡æ¢è§†å›¾
        function switchView(view) {
            document.getElementById('quadrantView').style.display = view === 'quadrant' ? 'grid' : 'none';
            document.getElementById('listView').classList.toggle('active', view === 'list');
            document.getElementById('foldersView').classList.toggle('active', view === 'folders');
            document.getElementById('imagesView').classList.toggle('active', view === 'images');
            document.getElementById('analyticsView').classList.toggle('active', view === 'analytics');
            document.getElementById('logView').classList.toggle('active', view === 'log');
            
            if (view === 'list') {
                renderListView();
            } else if (view === 'folders') {
                renderFolders();
            } else if (view === 'images') {
                loadImagesFromDatabase();
            } else if (view === 'analytics') {
                updateAnalytics();
            } else if (view === 'log') {
                loadOperationLogs();
            }
            
            // æ›´æ–°ç­›é€‰çŠ¶æ€æ˜¾ç¤º
            updateFilterStatus();
        }
        
        // ä¿å­˜è§†å›¾åå¥½
        function saveViewPreference() {
            localStorage.setItem('preferredView', currentView);
        }
        
        // åŠ è½½è§†å›¾åå¥½
        function loadViewPreference() {
            const preferredView = localStorage.getItem('preferredView');
            if (preferredView) {
                currentView = preferredView;
                document.querySelectorAll('.tab').forEach(tab => {
                    tab.classList.remove('active');
                    if (tab.dataset.view === preferredView) {
                        tab.classList.add('active');
                    }
                });
                switchView(preferredView);
            }
        }
        
        // è·å–ç­›é€‰åçš„ä»»åŠ¡
        function getFilteredTasks() {
            if (!currentFilter.startDate && !currentFilter.endDate) {
                return tasks;
            }
            
            return tasks.filter(task => {
                const taskDate = new Date(task.createdAt);
                return (!currentFilter.startDate || taskDate >= currentFilter.startDate) &&
                       (!currentFilter.endDate || taskDate <= currentFilter.endDate);
            });
        }
        
        // æ¸²æŸ“åˆ—è¡¨è§†å›¾
        function renderListView() {
            const listContainer = document.getElementById('listTasks');
            listContainer.innerHTML = '';
            
            const filteredTasks = getFilteredTasks();
            
            if (filteredTasks.length === 0) {
                listContainer.innerHTML = '<div class="empty-state">æ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„ä»»åŠ¡</div>';
                return;
            }
            
            // æ ¹æ®æ’åºæ–¹æ³•å¯¹ä»»åŠ¡è¿›è¡Œæ’åº
            let sortedTasks = [...filteredTasks];
            
            switch (listSortMethod) {
                case 'date':
                    sortedTasks.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                    break;
                case 'name':
                    sortedTasks.sort((a, b) => a.text.localeCompare(b.text));
                    break;
                case 'priority':
                    sortedTasks.sort((a, b) => a.priority - b.priority);
                    break;
                case 'category':
                    sortedTasks.sort((a, b) => a.category.localeCompare(b.category));
                    break;
            }
            
            // æŒ‰åˆ†ç»„æ¸²æŸ“ä»»åŠ¡
            if (listSortMethod === 'date') {
                // æŒ‰æ—¥æœŸåˆ†ç»„
                const groupedTasks = groupTasksByDate(sortedTasks);
                renderGroupedTasks(groupedTasks, 'date');
            } else if (listSortMethod === 'category') {
                // æŒ‰åˆ†ç±»åˆ†ç»„
                const groupedTasks = groupTasksByCategory(sortedTasks);
                renderGroupedTasks(groupedTasks, 'category');
            } else {
                // ä¸åˆ†ç»„ï¼Œç›´æ¥æ¸²æŸ“
                sortedTasks.forEach(task => {
                    renderListRow(task);
                });
            }
        }
        
        // æŒ‰æ—¥æœŸåˆ†ç»„ä»»åŠ¡
        function groupTasksByDate(tasks) {
            const groups = {};
            
            tasks.forEach(task => {
                const date = new Date(task.createdAt).toLocaleDateString();
                if (!groups[date]) {
                    groups[date] = [];
                }
                groups[date].push(task);
            });
            
            return groups;
        }
        
        // æŒ‰åˆ†ç±»åˆ†ç»„ä»»åŠ¡
        function groupTasksByCategory(tasks) {
            const groups = {};
            
            tasks.forEach(task => {
                const category = task.category;
                if (!groups[category]) {
                    groups[category] = [];
                }
                groups[category].push(task);
            });
            
            return groups;
        }
        
        // æ¸²æŸ“åˆ†ç»„ä»»åŠ¡
        function renderGroupedTasks(groups, groupType) {
            const listContainer = document.getElementById('listTasks');
            
            Object.keys(groups).sort((a, b) => {
                if (groupType === 'date') {
                    return new Date(b) - new Date(a);
                } else {
                    return a.localeCompare(b);
                }
            }).forEach(groupKey => {
                // æ·»åŠ åˆ†ç»„æ ‡é¢˜
                const groupHeader = document.createElement('div');
                groupHeader.className = 'list-group-header';
                groupHeader.textContent = groupType === 'date' ? 
                    groupKey : `${getCategoryNameById(groupKey)} (${groups[groupKey].length}é¡¹)`;
                listContainer.appendChild(groupHeader);
                
                // æ¸²æŸ“è¯¥ç»„å†…çš„ä»»åŠ¡
                groups[groupKey].forEach(task => {
                    renderListRow(task);
                });
            });
        }
        
        // æ¸²æŸ“åˆ—è¡¨è¡Œ
        function renderListRow(task) {
            const listContainer = document.getElementById('listTasks');
            const priorityText = ['ç´§æ€¥é‡è¦', 'é‡è¦', 'ç´§æ€¥', 'æ™®é€š'][task.priority - 1];
            
            const row = document.createElement('div');
            row.className = 'list-row' + (task.completed ? ' completed' : '');
            row.dataset.id = task.id;
            
            row.innerHTML = `
                <div><input type="checkbox" class="task-checkbox" ${task.completed ? 'checked' : ''}></div>
                <div class="task-text">${task.text}</div>
                <div class="priority">${priorityText}</div>
                <div>${getCategoryNameById(task.category)}</div>
                <div>
                    <button class="task-action edit-btn">âœï¸</button>
                    <button class="task-action delete-btn">ğŸ—‘ï¸</button>
                </div>
            `;
            
            listContainer.appendChild(row);
        }
        
        // æ¸²æŸ“å››è±¡é™è§†å›¾
        function renderQuadrantView() {
            // æ¸…ç©ºç°æœ‰ä»»åŠ¡åˆ—è¡¨
            document.querySelectorAll('.task-list').forEach(list => {
                list.innerHTML = '';
            });
            
            const filteredTasks = getFilteredTasks();
            
            // é‡æ–°æ¸²æŸ“æ‰€æœ‰ä»»åŠ¡
            filteredTasks.forEach(task => {
                renderTask(task);
            });
            
            // æ›´æ–°ä»»åŠ¡è®¡æ•°
            updateTaskStats();
        }
        
        // åˆå§‹åŒ–å›¾è¡¨
        function initChart() {
            try {
                const ctx = document.getElementById('taskChart').getContext('2d');
                window.taskChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: ['ç´§æ€¥ä¸”é‡è¦', 'é‡è¦ä¸ç´§æ€¥', 'ç´§æ€¥ä¸é‡è¦', 'ä¸ç´§æ€¥ä¸é‡è¦'],
                        datasets: [{
                            data: [0, 0, 0, 0],
                            backgroundColor: [
                                'rgba(255, 77, 77, 0.8)',
                                'rgba(255, 159, 28, 0.8)',
                                'rgba(46, 196, 182, 0.8)',
                                'rgba(203, 243, 240, 0.8)'
                            ],
                            borderColor: [
                                'rgba(255, 77, 77, 1)',
                                'rgba(255, 159, 28, 1)',
                                'rgba(46, 196, 182, 1)',
                                'rgba(203, 243, 240, 1)'
                            ],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const label = context.label || '';
                                        const value = context.raw || 0;
                                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                        const percentage = total > 0 ? Math.round((value / total) * 100) : 0;
                                        return `${label}: ${value} (${percentage}%)`;
                                    }
                                }
                            }
                        },
                        cutout: '70%'
                    }
                });
            } catch (error) {
                console.error('åˆå§‹åŒ–å›¾è¡¨å¤±è´¥:', error);
                document.getElementById('taskChart').parentElement.innerHTML = '<p>å›¾è¡¨åˆå§‹åŒ–å¤±è´¥</p>';
            }
        }
        
        // åˆå§‹åŒ–åˆ†æå›¾è¡¨
        function initAnalyticsCharts() {
            try {
                // ä»»åŠ¡åˆ†å¸ƒå›¾
                const distCtx = document.getElementById('taskDistributionChart').getContext('2d');
                window.taskDistributionChart = new Chart(distCtx, {
                    type: 'bar',
                    data: {
                        labels: ['ç´§æ€¥ä¸”é‡è¦', 'é‡è¦ä¸ç´§æ€¥', 'ç´§æ€¥ä¸é‡è¦', 'ä¸ç´§æ€¥ä¸é‡è¦'],
                        datasets: [{
                            label: 'ä»»åŠ¡æ•°é‡',
                            data: [0, 0, 0, 0],
                            backgroundColor: [
                                'rgba(255, 77, 77, 0.8)',
                                'rgba(255, 159, 28, 0.8)',
                                'rgba(46, 196, 182, 0.8)',
                                'rgba(203, 243, 240, 0.8)'
                            ],
                            borderColor: [
                                'rgba(255, 77, 77, 1)',
                                'rgba(255, 159, 28, 1)',
                                'rgba(46, 196, 182, 1)',
                                'rgba(203, 243, 240, 1)'
                            ],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
                
                // å®Œæˆæƒ…å†µå›¾
                const compCtx = document.getElementById('completionChart').getContext('2d');
                window.completionChart = new Chart(compCtx, {
                    type: 'pie',
                    data: {
                        labels: ['å·²å®Œæˆ', 'æœªå®Œæˆ'],
                        datasets: [{
                            data: [0, 0],
                            backgroundColor: [
                                'rgba(40, 167, 69, 0.8)',
                                'rgba(220, 53, 69, 0.8)'
                            ],
                            borderColor: [
                                'rgba(40, 167, 69, 1)',
                                'rgba(220, 53, 69, 1)'
                            ],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                            }
                        }
                    }
                });
                
                // ä¼˜å…ˆçº§åˆ†å¸ƒå›¾
                const prioCtx = document.getElementById('priorityChart').getContext('2d');
                window.priorityChart = new Chart(prioCtx, {
                    type: 'doughnut',
                    data: {
                        labels: ['ç´§æ€¥é‡è¦', 'é‡è¦', 'ç´§æ€¥', 'æ™®é€š'],
                        datasets: [{
                            data: [0, 0, 0, 0],
                            backgroundColor: [
                                'rgba(255, 77, 77, 0.8)',
                                'rgba(255, 159, 28, 0.8)',
                                'rgba(46, 196, 182, 0.8)',
                                'rgba(203, 243, 240, 0.8)'
                            ],
                            borderColor: [
                                'rgba(255, 77, 77, 1)',
                                'rgba(255, 159, 28, 1)',
                                'rgba(46, 196, 182, 1)',
                                'rgba(203, 243, 240, 1)'
                            ],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                            }
                        },
                        cutout: '70%'
                    }
                });
            } catch (error) {
                console.error('åˆå§‹åŒ–åˆ†æå›¾è¡¨å¤±è´¥:', error);
                document.querySelectorAll('.chart-container').forEach(container => {
                    container.innerHTML = '<p>å›¾è¡¨åˆå§‹åŒ–å¤±è´¥</p>';
                });
            }
        }
        
        // æ›´æ–°åˆ†ææ•°æ®
        function updateAnalytics() {
            try {
                const filteredTasks = getFilteredTasks();
                const totalTasks = filteredTasks.length;
                const completedTasks = filteredTasks.filter(t => t.completed).length;
                const completionRate = totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0;
                
                const urgentTasks = filteredTasks.filter(t => t.priority === 1);
                const urgentCompleted = urgentTasks.filter(t => t.completed).length;
                const urgentCompletionRate = urgentTasks.length > 0 ? Math.round((urgentCompleted / urgentTasks.length) * 100) : 0;
                
                // æ›´æ–°æ•°å­—æ˜¾ç¤º
                document.getElementById('completionRateBig').textContent = `${completionRate}%`;
                document.getElementById('urgentCompletion').textContent = `${urgentCompletionRate}%`;
                
                // æ›´æ–°å›¾è¡¨æ•°æ®
                const quadrantData = [0, 0, 0, 0];
                filteredTasks.forEach(task => {
                    quadrantData[task.quadrant - 1]++;
                });
                
                const priorityData = [0, 0, 0, 0];
                filteredTasks.forEach(task => {
                    priorityData[task.priority - 1]++;
                });
                
                const completedData = [
                    filteredTasks.filter(t => t.completed).length,
                    filteredTasks.filter(t => !t.completed).length
                ];
                
                if (window.taskDistributionChart) {
                    window.taskDistributionChart.data.datasets[0].data = quadrantData;
                    window.taskDistributionChart.update();
                }
                
                if (window.completionChart) {
                    window.completionChart.data.datasets[0].data = completedData;
                    window.completionChart.update();
                }
                
                if (window.priorityChart) {
                    window.priorityChart.data.datasets[0].data = priorityData;
                    window.priorityChart.update();
                }
                
                // æ›´æ–°ä»»åŠ¡æ¦‚è§ˆå›¾è¡¨
                updateTaskChart();
            } catch (error) {
                console.error('æ›´æ–°åˆ†ææ•°æ®å¤±è´¥:', error);
            }
        }
        
        // æ›´æ–°ä»»åŠ¡æ¦‚è§ˆå›¾è¡¨
        function updateTaskChart() {
            try {
                const filteredTasks = getFilteredTasks();
                const quadrantData = [0, 0, 0, 0];
                filteredTasks.forEach(task => {
                    quadrantData[task.quadrant - 1]++;
                });
                
                if (window.taskChart) {
                    window.taskChart.data.datasets[0].data = quadrantData;
                    window.taskChart.update();
                }
            } catch (error) {
                console.error('æ›´æ–°ä»»åŠ¡æ¦‚è§ˆå›¾è¡¨å¤±è´¥:', error);
            }
        }
        
        // æ›´æ–°ä»»åŠ¡ç»Ÿè®¡
        function updateTaskStats() {
            const filteredTasks = getFilteredTasks();
            const totalTasks = filteredTasks.length;
            const completedTasks = filteredTasks.filter(t => t.completed).length;
            const completionRate = totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0;
            const urgentTasks = filteredTasks.filter(t => t.priority === 1).length;
            
            document.getElementById('totalTasks').textContent = totalTasks;
            document.getElementById('completedTasks').textContent = completedTasks;
            document.getElementById('completionRate').textContent = `${completionRate}%`;
            document.getElementById('urgentTasks').textContent = urgentTasks;
            
            // æ›´æ–°å„è±¡é™çš„ä»»åŠ¡è®¡æ•°
            document.querySelectorAll('.quadrant').forEach(quadrant => {
                const quadrantId = parseInt(quadrant.className.split(' ')[1].split('-')[1]);
                const count = filteredTasks.filter(t => t.quadrant === quadrantId).length;
                quadrant.querySelector('.task-count').textContent = `${count}é¡¹`;
            });
            
            // æ›´æ–°ä»»åŠ¡æ¦‚è§ˆå›¾è¡¨
            updateTaskChart();
            
            // å¦‚æœå½“å‰æ˜¯åˆ†æè§†å›¾ï¼Œæ›´æ–°åˆ†ææ•°æ®
            if (currentView === 'analytics') {
                updateAnalytics();
            }
        }
        
        // æ›´æ–°ç­›é€‰çŠ¶æ€æ˜¾ç¤º
        function updateFilterStatus() {
            const statusElement = document.getElementById('filterStatus');
            
            if (!currentFilter.startDate && !currentFilter.endDate) {
                statusElement.textContent = 'æ˜¾ç¤ºæ‰€æœ‰ä»»åŠ¡';
                return;
            }
            
            const startDate = currentFilter.startDate ? new Date(currentFilter.startDate).toLocaleDateString() : 'ä¸é™';
            const endDate = currentFilter.endDate ? new Date(currentFilter.endDate).toLocaleDateString() : 'ä¸é™';
            
            statusElement.textContent = `ç­›é€‰: ${startDate} è‡³ ${endDate}`;
        }
        
        // æ·»åŠ æ–°ä»»åŠ¡
        function addNewTask() {
            const input = document.getElementById('newTaskInput');
            const text = input.value.trim();
            
            if (text) {
                // ç¡®å®šè±¡é™ (ç®€åŒ–é€»è¾‘: 1=ç´§æ€¥é‡è¦, 2=é‡è¦ä¸ç´§æ€¥, 3=ç´§æ€¥ä¸é‡è¦, 4=ä¸ç´§æ€¥ä¸é‡è¦)
                let quadrant;
                if (currentPriority === 1) quadrant = 1;
                else if (currentPriority === 2) quadrant = 2;
                else if (currentPriority === 3) quadrant = 3;
                else quadrant = 4;
                
                addTaskToQuadrant(text, quadrant);
                input.value = '';
                hideSuggestions(null);
                resetInactivityTimer();
            } else {
                // å¦‚æœæ²¡æœ‰è¾“å…¥å†…å®¹ï¼Œåˆ›å»ºä¸€ä¸ªç©ºä»»åŠ¡å¹¶æ‰“å¼€ç¼–è¾‘æ¨¡æ€æ¡†
                let quadrant;
                if (currentPriority === 1) quadrant = 1;
                else if (currentPriority === 2) quadrant = 2;
                else if (currentPriority === 3) quadrant = 3;
                else quadrant = 4;
                
                createEmptyTask(quadrant);
            }
        }
        
        // æ·»åŠ ä»»åŠ¡åˆ°æŒ‡å®šè±¡é™
        async function addTaskToQuadrant(text, quadrant) {
            // åˆ›å»ºæ–°ä»»åŠ¡
            const newTask = {
                text: text,
                priority: currentPriority,
                completed: false,
                quadrant: quadrant,
                category: getCategoryByPriority(currentPriority),
                createdAt: new Date().toISOString()
            };
            
            // ä¿å­˜åˆ°æ•°æ®åº“
            const savedTask = await saveTaskToDatabase(newTask);
            if (savedTask) {
                tasks.push(savedTask);
                renderTask(savedTask);
                
                // æ·»åŠ åˆ°å»ºè®®åˆ—è¡¨
                addSuggestion(text);
                
                // è®°å½•æ“ä½œæ—¥å¿—
                logOperation('add', `æ–°å¢ä»»åŠ¡ï¼š"${text}"ï¼ˆä¼˜å…ˆçº§ï¼š${currentPriority}ï¼Œè±¡é™ï¼š${getQuadrantName(quadrant)}ï¼‰`);
                
                updateTaskStats();
            }
        }
        
        // æ ¹æ®è±¡é™è·å–åç§°
        function getQuadrantName(quadrant) {
            const names = {
                1: 'ç´§æ€¥ä¸”é‡è¦',
                2: 'é‡è¦ä¸ç´§æ€¥',
                3: 'ç´§æ€¥ä¸é‡è¦',
                4: 'ä¸ç´§æ€¥ä¸é‡è¦'
            };
            return names[quadrant] || '';
        }
        
        // æ ¹æ®ä¼˜å…ˆçº§è·å–åˆ†ç±»
        function getCategoryByPriority(priority) {
            const categories = {
                1: "ç´§æ€¥å¤„ç†",
                2: "æˆ˜ç•¥è§„åˆ’",
                3: "æ—¥å¸¸åº”æ€¥",
                4: "å¸¸è§„äº‹åŠ¡"
            };
            return categories[priority] || "å…¶ä»–";
        }
        
        // æ˜¾ç¤ºå»ºè®®
        function showSuggestions(text, quadrant) {
            const suggestions = getSuggestions(text, quadrant);
            const containerId = quadrant ? `suggestions${quadrant}` : 'mainSuggestions';
            const container = document.getElementById(containerId);
            
            container.innerHTML = '';
            
            if (suggestions.length === 0) {
                container.style.display = 'none';
                return;
            }
            
            suggestions.forEach((suggestion, index) => {
                const item = document.createElement('div');
                item.className = 'suggestion-item';
                item.innerHTML = `
                    <span>${suggestion}</span>
                    <span class="suggestion-edit" data-index="${index}">âœï¸</span>
                `;
                
                item.addEventListener('click', function(e) {
                    if (!e.target.classList.contains('suggestion-edit')) {
                        const input = container.previousElementSibling;
                        input.value = suggestion;
                        input.focus();
                        hideSuggestions(quadrant);
                    }
                });
                
                const editBtn = item.querySelector('.suggestion-edit');
                editBtn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    editingSuggestionIndex = index;
                    document.getElementById('editSuggestionText').value = suggestion;
                    showModal('editSuggestionModal');
                });
                
                container.appendChild(item);
            });
            
            container.style.display = 'block';
        }
        
        // éšè—å»ºè®®
        function hideSuggestions(quadrant) {
            const containerId = quadrant ? `suggestions${quadrant}` : 'mainSuggestions';
            const container = document.getElementById(containerId);
            container.style.display = 'none';
        }
        
        // è·å–å»ºè®®
        function getSuggestions(text, quadrant) {
            if (!text) {
                return [];
            }
            
            const lowerText = text.toLowerCase();
            return taskSuggestions
                .filter(suggestion => suggestion.toLowerCase().includes(lowerText))
                .slice(0, 5);
        }
        
        // æ·»åŠ å»ºè®®
        function addSuggestion(text) {
            if (!taskSuggestions.includes(text)) {
                taskSuggestions.unshift(text);
                if (taskSuggestions.length > 50) {
                    taskSuggestions.pop();
                }
                // ä¿å­˜å»ºè®®åˆ°localStorageï¼ˆä»…å»ºè®®ä½¿ç”¨æœ¬åœ°å­˜å‚¨ï¼‰
                localStorage.setItem('taskSuggestions', JSON.stringify(taskSuggestions));
            }
        }
        
        // ä¿å­˜ç¼–è¾‘çš„å»ºè®®
        function saveEditedSuggestion() {
            const newText = document.getElementById('editSuggestionText').value.trim();
            if (newText && editingSuggestionIndex !== -1) {
                taskSuggestions[editingSuggestionIndex] = newText;
                // ä¿å­˜å»ºè®®åˆ°localStorageï¼ˆä»…å»ºè®®ä½¿ç”¨æœ¬åœ°å­˜å‚¨ï¼‰
                localStorage.setItem('taskSuggestions', JSON.stringify(taskSuggestions));
                hideModal('editSuggestionModal');
                
                // æ›´æ–°æ‰€æœ‰å»ºè®®åˆ—è¡¨
                document.querySelectorAll('.add-task-input').forEach(input => {
                    const quadrant = parseInt(input.dataset.quadrant);
                    showSuggestions(input.value, quadrant);
                });
                
                showSuggestions(document.getElementById('newTaskInput').value, null);
            }
        }
        
        // æ¸²æŸ“ä»»åŠ¡åˆ°å¯¹åº”è±¡é™
        function renderTask(task) {
            const quadrantId = `quadrant${task.quadrant}`;
            const quadrantList = document.getElementById(quadrantId);
            
            const taskItem = document.createElement('li');
            taskItem.className = 'task-item' + (task.completed ? ' completed' : '');
            taskItem.dataset.id = task.id;
            taskItem.dataset.priority = task.priority;
            
            const taskDate = new Date(task.createdAt);
            const dateString = taskDate.toLocaleDateString('zh-CN', {year: 'numeric', month: '2-digit', day: '2-digit'});
            
            taskItem.innerHTML = `
                <input type="checkbox" class="task-checkbox" ${task.completed ? 'checked' : ''}>
                <span class="task-priority priority-${task.priority}"></span>
                <span class="task-text">${task.text}</span>
                <span class="task-date">${dateString}</span>
                <div class="task-actions">
                    <button class="task-action edit-btn">âœï¸</button>
                    <button class="task-action delete-btn">ğŸ—‘ï¸</button>
                </div>
            `;
            
            quadrantList.appendChild(taskItem);
            
            // ç¡®ä¿ä»»åŠ¡å®¹å™¨æ˜¯å±•å¼€çš„
            document.getElementById(`taskContainer${task.quadrant}`).style.display = 'block';
            
            // æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
            const checkbox = taskItem.querySelector('.task-checkbox');
            checkbox.addEventListener('change', function() {
                task.completed = this.checked;
                taskItem.classList.toggle('completed', task.completed);
                
                // æ›´æ–°æ•°æ®åº“
                updateTaskInDatabase(task);
                
                // è®°å½•æ“ä½œæ—¥å¿—
                logOperation(task.completed ? 'complete' : 'incomplete', 
                             `æ ‡è®°ä»»åŠ¡ä¸º${task.completed ? 'å·²å®Œæˆ' : 'æœªå®Œæˆ'}ï¼š"${task.text}"ï¼ˆè±¡é™ï¼š${getQuadrantName(task.quadrant)}ï¼‰`);
                
                updateTaskStats();
            });
            
            const editBtn = taskItem.querySelector('.edit-btn');
            editBtn.addEventListener('click', function() {
                openEditModal(task.id);
            });
            
            const deleteBtn = taskItem.querySelector('.delete-btn');
            deleteBtn.addEventListener('click', function() {
                deleteTask(task.id);
            });
            
            // å¦‚æœå½“å‰æ˜¯åˆ—è¡¨è§†å›¾ï¼Œæ›´æ–°åˆ—è¡¨
            if (currentView === 'list') {
                renderListView();
            }
        }
        
        // æ‰“å¼€ç¼–è¾‘æ¨¡æ€æ¡†
        function openEditModal(taskId) {
            const task = tasks.find(t => t.id === taskId);
            if (task) {
                editingTaskId = taskId;
                document.getElementById('editTaskText').value = task.text;
                
                // æ›´æ–°åˆ†ç±»é€‰æ‹©å™¨
                updateCategorySelectors();
                document.getElementById('editTaskCategory').value = task.category;
                
                // è®¾ç½®ä¼˜å…ˆçº§é€‰æ‹©
                document.querySelectorAll('#editModal .priority-option').forEach(option => {
                    option.classList.remove('selected');
                    if (parseInt(option.dataset.priority) === task.priority) {
                        option.classList.add('selected');
                    }
                });
                
                // æ·»åŠ ä¼˜å…ˆçº§é€‰æ‹©äº‹ä»¶
                document.querySelectorAll('#editModal .priority-option').forEach(option => {
                    option.addEventListener('click', function() {
                        document.querySelectorAll('#editModal .priority-option').forEach(opt => {
                            opt.classList.remove('selected');
                        });
                        this.classList.add('selected');
                    });
                });
                
                showModal('editModal');
            }
        }
        
        // å…³é—­ç¼–è¾‘æ¨¡æ€æ¡†
        function closeEditModal() {
            hideModal('editModal');
            editingTaskId = null;
        }
        
        // ä¿å­˜ç¼–è¾‘åçš„ä»»åŠ¡
        async function saveEditedTask() {
            if (editingTaskId !== null) {
                const task = tasks.find(t => t.id === editingTaskId);
                if (task) {
                    const oldText = task.text;
                    const oldPriority = task.priority;
                    const oldCategory = task.category;
                    const oldQuadrant = task.quadrant;
                    
                    task.text = document.getElementById('editTaskText').value;
                    task.category = document.getElementById('editTaskCategory').value;
                    
                    const selectedPriority = document.querySelector('#editModal .priority-option.selected');
                    if (selectedPriority) {
                        const newPriority = parseInt(selectedPriority.dataset.priority);
                        task.priority = newPriority;
                        
                        // æ›´æ–°è±¡é™
                        if (newPriority === 1) task.quadrant = 1;
                        else if (newPriority === 2) task.quadrant = 2;
                        else if (newPriority === 3) task.quadrant = 3;
                        else task.quadrant = 4;
                    }
                    
                    // æ›´æ–°æ•°æ®åº“
                    const savedTask = await updateTaskInDatabase(task);
                    if (savedTask) {
                        // è®°å½•æ“ä½œæ—¥å¿—
                        let changes = [];
                        if (oldText !== task.text) changes.push(`å†…å®¹ä»"${oldText}"ä¿®æ”¹ä¸º"${task.text}"`);
                        if (oldPriority !== task.priority) changes.push(`ä¼˜å…ˆçº§ä»${oldPriority}ä¿®æ”¹ä¸º${task.priority}`);
                        if (oldCategory !== task.category) changes.push(`åˆ†ç±»ä»"${getCategoryNameById(oldCategory)}"ä¿®æ”¹ä¸º"${getCategoryNameById(task.category)}"`);
                        if (oldQuadrant !== task.quadrant) changes.push(`è±¡é™ä»"${getQuadrantName(oldQuadrant)}"ä¿®æ”¹ä¸º"${getQuadrantName(task.quadrant)}"`);
                        
                        if (changes.length > 0) {
                            logOperation('edit', `ç¼–è¾‘ä»»åŠ¡ï¼š${changes.join('ï¼Œ')}ï¼ˆè±¡é™ï¼š${getQuadrantName(task.quadrant)}ï¼‰`);
                        }
                        
                        // é‡æ–°æ¸²æŸ“æ‰€æœ‰è§†å›¾
                        renderQuadrantView();
                        
                        if (currentView === 'list') {
                            renderListView();
                        }
                        
                        updateTaskStats();
                        closeEditModal();
                    }
                }
            }
        }
        
        // åˆ é™¤ä»»åŠ¡
        async function deleteTask(taskId) {
            const task = tasks.find(t => t.id === taskId);
            if (task) {
                if (confirm(`ç¡®å®šè¦åˆ é™¤ä»»åŠ¡"${task.text}"å—ï¼Ÿ`)) {
                    // æ·»åŠ åˆ°å·²åˆ é™¤ä»»åŠ¡åˆ—è¡¨
                    const deletedTask = {
                        ...task,
                        deletedAt: new Date().toISOString()
                    };
                    deletedTasks.push(deletedTask);
                    
                    // ä»æ•°æ®åº“åˆ é™¤
                    const success = await deleteTaskFromDatabase(taskId);
                    if (success) {
                        // è®°å½•æ“ä½œæ—¥å¿—
                        logOperation('delete', `åˆ é™¤ä»»åŠ¡ï¼š"${task.text}"ï¼ˆID: ${taskId}ï¼Œè±¡é™ï¼š${getQuadrantName(task.quadrant)}ï¼‰`);
                        
                        tasks = tasks.filter(t => t.id !== taskId);
                        document.querySelector(`.task-item[data-id="${taskId}"]`)?.remove();
                        document.querySelector(`.list-row[data-id="${taskId}"]`)?.remove();
                        updateTaskStats();
                    }
                }
            }
        }
        
        // åˆ é™¤é€‰ä¸­ä»»åŠ¡
        async function deleteSelectedTasks() {
            const selectedCheckboxes = document.querySelectorAll('.task-checkbox:checked');
            if (selectedCheckboxes.length === 0) {
                alert('è¯·å…ˆé€‰æ‹©è¦åˆ é™¤çš„ä»»åŠ¡');
                return;
            }
            
            if (confirm(`ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„ ${selectedCheckboxes.length} é¡¹ä»»åŠ¡å—ï¼Ÿ`)) {
                let successCount = 0;
                for (const checkbox of selectedCheckboxes) {
                    const taskId = parseInt(checkbox.closest('.task-item, .list-row').dataset.id);
                    const task = tasks.find(t => t.id === taskId);
                    
                    if (task) {
                        // æ·»åŠ åˆ°å·²åˆ é™¤ä»»åŠ¡åˆ—è¡¨
                        const deletedTask = {
                            ...task,
                            deletedAt: new Date().toISOString()
                        };
                        deletedTasks.push(deletedTask);
                        
                        // ä»æ•°æ®åº“åˆ é™¤
                        const success = await deleteTaskFromDatabase(taskId);
                        if (success) {
                            successCount++;
                            
                            // è®°å½•æ“ä½œæ—¥å¿—
                            logOperation('delete', `åˆ é™¤ä»»åŠ¡ï¼š"${task.text}"ï¼ˆID: ${taskId}ï¼Œè±¡é™ï¼š${getQuadrantName(task.quadrant)}ï¼‰`);
                        }
                        
                        tasks = tasks.filter(t => t.id !== taskId);
                        checkbox.closest('.task-item, .list-row').remove();
                    }
                }
                
                updateTaskStats();
            }
        }
        
        // åˆ é™¤å·²å®Œæˆä»»åŠ¡
        async function deleteCompletedTasks() {
            const completedTasks = tasks.filter(t => t.completed);
            if (completedTasks.length === 0) {
                alert('æ²¡æœ‰å·²å®Œæˆçš„ä»»åŠ¡');
                return;
            }
            
            if (confirm(`ç¡®å®šè¦åˆ é™¤ ${completedTasks.length} é¡¹å·²å®Œæˆä»»åŠ¡å—ï¼Ÿ`)) {
                let successCount = 0;
                // æ·»åŠ åˆ°å·²åˆ é™¤ä»»åŠ¡åˆ—è¡¨å¹¶è®°å½•æ“ä½œæ—¥å¿—
                for (const task of completedTasks) {
                    const deletedTask = {
                        ...task,
                        deletedAt: new Date().toISOString()
                    };
                    deletedTasks.push(deletedTask);
                    
                    // ä»æ•°æ®åº“åˆ é™¤
                    const success = await deleteTaskFromDatabase(task.id);
                    if (success) {
                        successCount++;
                    }
                    
                    logOperation('delete', `åˆ é™¤å·²å®Œæˆä»»åŠ¡ï¼š"${task.text}"ï¼ˆID: ${task.id}ï¼Œè±¡é™ï¼š${getQuadrantName(task.quadrant)}ï¼‰`);
                }
                
                tasks = tasks.filter(t => !t.completed);
                document.querySelectorAll('.task-item.completed, .list-row.completed').forEach(item => item.remove());
                
                updateTaskStats();
            }
        }
        
        // æ¸…ç©ºæ‰€æœ‰ä»»åŠ¡
        async function clearAllTasks() {
            if (tasks.length === 0) {
                alert('æ²¡æœ‰ä»»åŠ¡å¯æ¸…ç©º');
                return;
            }
            
            if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰ä»»åŠ¡å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) {
                let successCount = 0;
                // æ·»åŠ åˆ°å·²åˆ é™¤ä»»åŠ¡åˆ—è¡¨
                for (const task of tasks) {
                    const deletedTask = {
                        ...task,
                        deletedAt: new Date().toISOString(),
                        isSystemDeleted: false
                    };
                    deletedTasks.push(deletedTask);
                    
                    // ä»æ•°æ®åº“åˆ é™¤
                    const success = await deleteTaskFromDatabase(task.id);
                    if (success) {
                        successCount++;
                    }
                }
                
                // è®°å½•æ“ä½œæ—¥å¿—
                logOperation('delete', `æ¸…ç©ºæ‰€æœ‰ä»»åŠ¡ï¼ˆå…±${tasks.length}é¡¹ï¼‰`);
                
                tasks = [];
                document.querySelectorAll('.task-list').forEach(list => {
                    list.innerHTML = '';
                });
                document.getElementById('listTasks').innerHTML = '';
                
                updateTaskStats();
            }
        }
        
        // æ˜¾ç¤ºå·²åˆ é™¤ä»»åŠ¡
        function showDeletedTasks() {
            const deletedList = document.getElementById('deletedTasksList');
            deletedList.innerHTML = '';
            
            if (deletedTasks.length === 0) {
                deletedList.innerHTML = '<li class="empty-state">æ²¡æœ‰å·²åˆ é™¤çš„ä»»åŠ¡</li>';
            } else {
                // æŒ‰åˆ é™¤æ—¶é—´å€’åºæ’åˆ—
                const sortedDeletedTasks = [...deletedTasks].sort((a, b) => 
                    new Date(b.deletedAt) - new Date(a.deletedAt));
                
                sortedDeletedTasks.forEach(task => {
                    const priorityText = ['ç´§æ€¥é‡è¦', 'é‡è¦', 'ç´§æ€¥', 'æ™®é€š'][task.priority - 1];
                    const quadrantText = getQuadrantName(task.quadrant);
                    const deletedDate = new Date(task.deletedAt).toLocaleString();
                    const isSystemDeleted = task.isSystemDeleted ? 'ï¼ˆç³»ç»Ÿè‡ªåŠ¨åˆ é™¤ï¼‰' : '';
                    
                    const item = document.createElement('li');
                    item.className = 'deleted-task-item';
                    item.innerHTML = `
                        <div style="display: flex; align-items: center;">
                            <input type="checkbox" class="task-checkbox" style="margin-right: 10px;" data-id="${task.id}">
                            <div class="deleted-task-info">
                                <div><strong>${task.text}</strong> ${isSystemDeleted}</div>
                                <div>ä¼˜å…ˆçº§: ${priorityText} | åˆ†ç±»: ${getCategoryNameById(task.category)} | è±¡é™: ${quadrantText}</div>
                                <div>åˆ é™¤æ—¶é—´: ${deletedDate}</div>
                            </div>
                        </div>
                        <div class="deleted-task-actions">
                            <button class="restore-btn" data-id="${task.id}">æ¢å¤</button>
                            <button class="permanently-delete-btn" data-id="${task.id}">æ°¸ä¹…åˆ é™¤</button>
                        </div>
                    `;
                    
                    // æ·»åŠ æ¢å¤æŒ‰é’®äº‹ä»¶
                    const restoreBtn = item.querySelector('.restore-btn');
                    restoreBtn.addEventListener('click', function() {
                        restoreTask(task.id);
                    });
                    
                    // æ·»åŠ æ°¸ä¹…åˆ é™¤æŒ‰é’®äº‹ä»¶
                    const deleteBtn = item.querySelector('.permanently-delete-btn');
                    deleteBtn.addEventListener('click', function() {
                        permanentlyDeleteTask(task.id);
                    });
                    
                    deletedList.appendChild(item);
                });
            }
            
            showModal('deletedTasksModal');
        }
        
        // ç­›é€‰å·²åˆ é™¤ä»»åŠ¡
        function filterDeletedTasks() {
            const searchText = document.getElementById('searchDeletedTasks').value.toLowerCase();
            const items = document.querySelectorAll('.deleted-task-item');
            
            items.forEach(item => {
                const taskText = item.querySelector('.deleted-task-info').textContent.toLowerCase();
                if (taskText.includes(searchText)) {
                    item.style.display = 'flex';
                } else {
                    item.style.display = 'none';
                }
            });
        }
        
        // æ¸…é™¤å·²åˆ é™¤ä»»åŠ¡æœç´¢
        function clearDeletedTasksSearch() {
            document.getElementById('searchDeletedTasks').value = '';
            const items = document.querySelectorAll('.deleted-task-item');
            items.forEach(item => {
                item.style.display = 'flex';
            });
        }
        
        // æ¢å¤é€‰ä¸­çš„ä»»åŠ¡
        function restoreSelectedTasks() {
            const selectedCheckboxes = document.querySelectorAll('#deletedTasksList .task-checkbox:checked');
            if (selectedCheckboxes.length === 0) {
                alert('è¯·å…ˆé€‰æ‹©è¦æ¢å¤çš„ä»»åŠ¡');
                return;
            }
            
            if (confirm(`ç¡®å®šè¦æ¢å¤é€‰ä¸­çš„ ${selectedCheckboxes.length} é¡¹ä»»åŠ¡å—ï¼Ÿ`)) {
                selectedCheckboxes.forEach(checkbox => {
                    const taskId = parseInt(checkbox.dataset.id);
                    restoreTask(taskId);
                });
                
                // é‡æ–°æ˜¾ç¤ºå·²åˆ é™¤ä»»åŠ¡åˆ—è¡¨
                showDeletedTasks();
            }
        }
        
        // å…³é—­å·²åˆ é™¤ä»»åŠ¡æ¨¡æ€æ¡†
        function closeDeletedTasksModal() {
            hideModal('deletedTasksModal');
        }
        
        // æ¢å¤ä»»åŠ¡
        async function restoreTask(taskId) {
            const taskIndex = deletedTasks.findIndex(t => t.id === taskId);
            if (taskIndex !== -1) {
                const task = deletedTasks[taskIndex];
                
                // ä»å·²åˆ é™¤åˆ—è¡¨ä¸­ç§»é™¤
                deletedTasks.splice(taskIndex, 1);
                
                // æ·»åŠ åˆ°ä»»åŠ¡åˆ—è¡¨
                tasks.push(task);
                renderTask(task);
                
                // ä¿å­˜åˆ°æ•°æ®åº“
                const savedTask = await saveTaskToDatabase(task);
                if (savedTask) {
                    // è®°å½•æ“ä½œæ—¥å¿—
                    logOperation('restore', `æ¢å¤ä»»åŠ¡ï¼š"${task.text}"ï¼ˆID: ${task.id}ï¼Œè±¡é™ï¼š${getQuadrantName(task.quadrant)}ï¼‰`);
                    
                    // æ›´æ–°UI
                    updateTaskStats();
                }
            }
        }
        
        // æ°¸ä¹…åˆ é™¤ä»»åŠ¡
        function permanentlyDeleteTask(taskId) {
            if (confirm('ç¡®å®šè¦æ°¸ä¹…åˆ é™¤æ­¤ä»»åŠ¡å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) {
                const taskIndex = deletedTasks.findIndex(t => t.id === taskId);
                if (taskIndex !== -1) {
                    const task = deletedTasks[taskIndex];
                    
                    // è®°å½•æ“ä½œæ—¥å¿—
                    logOperation('delete', `æ°¸ä¹…åˆ é™¤ä»»åŠ¡ï¼š"${task.text}"ï¼ˆID: ${task.id}ï¼‰`);
                    
                    // ä»å·²åˆ é™¤åˆ—è¡¨ä¸­ç§»é™¤
                    deletedTasks.splice(taskIndex, 1);
                    
                    // æ›´æ–°UI
                    document.querySelector(`#deletedTasksList li input[data-id="${taskId}"]`)?.closest('li').remove();
                }
            }
        }
        
        // åº”ç”¨å¿«æ·æ—¥æœŸç­›é€‰
        function applyQuickFilter() {
            const quickFilter = document.getElementById('quickDateFilter').value;
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            let startDate, endDate;
            
            switch (quickFilter) {
                case 'today':
                    startDate = today;
                    endDate = new Date(today);
                    endDate.setHours(23, 59, 59, 999);
                    break;
                case 'yesterday':
                    startDate = new Date(today);
                    startDate.setDate(today.getDate() - 1);
                    endDate = new Date(startDate);
                    endDate.setHours(23, 59, 59, 999);
                    break;
                case 'last7days':
                    startDate = new Date(today);
                    startDate.setDate(today.getDate() - 6);
                    endDate = new Date(today);
                    endDate.setHours(23, 59, 59, 999);
                    break;
                case 'last15days':
                    startDate = new Date(today);
                    startDate.setDate(today.getDate() - 14);
                    endDate = new Date(today);
                    endDate.setHours(23, 59, 59, 999);
                    break;
                case 'last30days':
                    startDate = new Date(today);
                    startDate.setDate(today.getDate() - 29);
                    endDate = new Date(today);
                    endDate.setHours(23, 59, 59, 999);
                    break;
                case 'thismonth':
                    startDate = new Date(today.getFullYear(), today.getMonth(), 1);
                    endDate = new Date(today.getFullYear(), today.getMonth() + 1, 0);
                    endDate.setHours(23, 59, 59, 999);
                    break;
                case 'lastmonth':
                    startDate = new Date(today.getFullYear(), today.getMonth() - 1, 1);
                    endDate = new Date(today.getFullYear(), today.getMonth(), 0);
                    endDate.setHours(23, 59, 59, 999);
                    break;
                case 'thisyear':
                    startDate = new Date(today.getFullYear(), 0, 1);
                    endDate = new Date(today.getFullYear(), 11, 31);
                    endDate.setHours(23, 59, 59, 999);
                    break;
                case 'lastyear':
                    startDate = new Date(today.getFullYear() - 1, 0, 1);
                    endDate = new Date(today.getFullYear() - 1, 11, 31);
                    endDate.setHours(23, 59, 59, 999);
                    break;
                case 'all':
                    resetDateFilter();
                    return;
            }
            
            // æ›´æ–°UI
            document.getElementById('startDate').value = startDate.toISOString().split('T')[0];
            document.getElementById('endDate').value = endDate.toISOString().split('T')[0];
            
            // æ›´æ–°ç­›é€‰çŠ¶æ€
            currentFilter.quickFilter = quickFilter;
            currentFilter.startDate = startDate;
            currentFilter.endDate = endDate;
            
            // åº”ç”¨ç­›é€‰
            applyDateFilter();
        }
        
        // åº”ç”¨æ—¥æœŸç­›é€‰
        function applyDateFilter() {
            const startDateStr = document.getElementById('startDate').value;
            const endDateStr = document.getElementById('endDate').value;
            
            if (!startDateStr && !endDateStr) {
                // æ²¡æœ‰ç­›é€‰æ¡ä»¶ï¼Œæ˜¾ç¤ºæ‰€æœ‰
                currentFilter.startDate = null;
                currentFilter.endDate = null;
            } else {
                // æ›´æ–°ç­›é€‰çŠ¶æ€
                currentFilter.startDate = startDateStr ? new Date(startDateStr) : null;
                currentFilter.endDate = endDateStr ? new Date(endDateStr) : null;
                
                if (currentFilter.endDate) {
                    currentFilter.endDate.setHours(23, 59, 59, 999);
                }
            }
            
            // æ ¹æ®å½“å‰è§†å›¾æ›´æ–°æ˜¾ç¤º
            switch (currentView) {
                case 'quadrant':
                    renderQuadrantView();
                    break;
                case 'list':
                    renderListView();
                    break;
                case 'analytics':
                    updateAnalytics();
                    break;
                case 'log':
                    loadOperationLogs();
                    break;
            }
            
            // æ›´æ–°ç­›é€‰çŠ¶æ€æ˜¾ç¤º
            updateFilterStatus();
        }
        
        // é‡ç½®æ—¥æœŸç­›é€‰
        function resetDateFilter() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('quickDateFilter').value = 'today';
            document.getElementById('startDate').value = today;
            document.getElementById('endDate').value = today;
            
            // é‡ç½®ç­›é€‰çŠ¶æ€
            currentFilter.quickFilter = 'today';
            currentFilter.startDate = new Date(today);
            currentFilter.endDate = new Date(today);
            currentFilter.endDate.setHours(23, 59, 59, 999);
            
            // åº”ç”¨é‡ç½®
            applyDateFilter();
        }
        
        // è®°å½•æ“ä½œæ—¥å¿—
        async function logOperation(type, content) {
            const logEntry = {
                timestamp: new Date().toISOString(),
                type: type,
                content: content,
                operator: 'ç®¡ç†å‘˜'
            };
            operationLogs.push(logEntry);
            
            // ä¿å­˜åˆ°æ•°æ®åº“
            if (supabase) {
                await saveLogToDatabase(logEntry);
            }
            
            // å¦‚æœå½“å‰åœ¨æ—¥å¿—è§†å›¾ï¼Œåˆ·æ–°æ˜¾ç¤º
            if (currentView === 'log') {
                loadOperationLogs(currentLogPage);
            }
        }
        
        // æ¸…é™¤æ“ä½œæ—¥å¿—
        function clearLogs() {
            const selectedCheckboxes = document.querySelectorAll('#logList .log-checkbox:checked');
            if (selectedCheckboxes.length === 0) {
                if (confirm('ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰æ“ä½œè®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) {
                    operationLogs = [];
                    loadOperationLogs();
                }
            } else {
                if (confirm(`ç¡®å®šè¦æ¸…é™¤é€‰ä¸­çš„ ${selectedCheckboxes.length} æ¡æ“ä½œè®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼`)) {
                    const selectedIds = Array.from(selectedCheckboxes).map(checkbox => 
                        checkbox.closest('tr').dataset.id);
                    
                    operationLogs = operationLogs.filter(log => 
                        !selectedIds.includes(log.timestamp));
                    
                    loadOperationLogs();
                }
            }
        }
        
        // åŠ è½½æ“ä½œæ—¥å¿—
        function loadOperationLogs(page = 1) {
            currentLogPage = page;
            const start = (page - 1) * logPageSize;
            const end = start + logPageSize;
            const filteredLogs = filterLogs();
            const paginatedLogs = filteredLogs.slice(start, end);

            renderLogs(paginatedLogs);
            renderPagination(filteredLogs.length, page);
        }
        
        // ç­›é€‰æ—¥å¿—
        function filterLogs() {
            const typeFilter = document.getElementById('logType').value;
            const startDate = currentFilter.startDate;
            const endDate = currentFilter.endDate;

            return operationLogs.filter(log => {
                const logDate = new Date(log.timestamp);
                const matchType = typeFilter === 'all' || log.type === typeFilter;
                const matchStartDate = !startDate || logDate >= startDate;
                const matchEndDate = !endDate || logDate <= endDate;
                
                return matchType && matchStartDate && matchEndDate;
            }).sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
        }
        
        // æ¸²æŸ“æ—¥å¿—
        function renderLogs(logs) {
            const tbody = document.getElementById('logList');
            tbody.innerHTML = '';
            
            if (logs.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" class="empty-state">æ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„æ“ä½œè®°å½•</td>
                    </tr>
                `;
                return;
            }
            
            logs.forEach(log => {
                const row = document.createElement('tr');
                row.dataset.id = log.timestamp;
                row.innerHTML = `
                    <td><input type="checkbox" class="log-checkbox"></td>
                    <td>${new Date(log.timestamp).toLocaleString()}</td>
                    <td>
                        <span class="log-type ${log.type}">
                            ${{
                                add: 'æ–°å¢ä»»åŠ¡',
                                delete: 'åˆ é™¤ä»»åŠ¡',
                                complete: 'å®Œæˆä»»åŠ¡',
                                incomplete: 'æ ‡è®°æœªå®Œæˆ',
                                edit: 'ç¼–è¾‘ä»»åŠ¡',
                                restore: 'æ¢å¤ä»»åŠ¡',
                                system: 'ç³»ç»Ÿ'
                            }[log.type] || log.type}
                        </span>
                    </td>
                    <td>${log.content}</td>
                    <td>${log.operator}</td>
                `;
                tbody.appendChild(row);
            });
        }
        
        // æ¸²æŸ“åˆ†é¡µ
        function renderPagination(total, currentPage) {
            const totalPages = Math.ceil(total / logPageSize);
            const pagination = document.getElementById('logPagination');
            
            if (totalPages <= 1) {
                pagination.innerHTML = '';
                return;
            }
            
            let buttons = [];
            
            // ä¸Šä¸€é¡µæŒ‰é’®
            buttons.push(`
                <button class="page-btn ${currentPage === 1 ? 'disabled' : ''}" 
                        onclick="loadOperationLogs(${currentPage - 1})" 
                        ${currentPage === 1 ? 'disabled' : ''}>
                    ä¸Šä¸€é¡µ
                </button>
            `);
            
            // é¡µç æŒ‰é’®
            const maxVisiblePages = 5;
            let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
            let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
            
            if (endPage - startPage + 1 < maxVisiblePages) {
                startPage = Math.max(1, endPage - maxVisiblePages + 1);
            }
            
            if (startPage > 1) {
                buttons.push(`
                    <button class="page-btn" onclick="loadOperationLogs(1)">1</button>
                    ${startPage > 2 ? '<span>...</span>' : ''}
                `);
            }
            
            for (let i = startPage; i <= endPage; i++) {
                buttons.push(`
                    <button class="page-btn ${i === currentPage ? 'active' : ''}" 
                            onclick="loadOperationLogs(${i})">
                        ${i}
                    </button>
                `);
            }
            
            if (endPage < totalPages) {
                buttons.push(`
                    ${endPage < totalPages - 1 ? '<span>...</span>' : ''}
                    <button class="page-btn" onclick="loadOperationLogs(${totalPages})">${totalPages}</button>
                `);
            }
            
            // ä¸‹ä¸€é¡µæŒ‰é’®
            buttons.push(`
                <button class="page-btn ${currentPage === totalPages ? 'disabled' : ''}" 
                        onclick="loadOperationLogs(${currentPage + 1})" 
                        ${currentPage === totalPages ? 'disabled' : ''}>
                    ä¸‹ä¸€é¡µ
                </button>
            `);
            
            pagination.innerHTML = buttons.join('');
        }
        
        // ä»æœ¬åœ°å­˜å‚¨åŠ è½½å»ºè®®
        function loadSuggestionsFromLocalStorage() {
            const savedSuggestions = localStorage.getItem('taskSuggestions');
            if (savedSuggestions) {
                taskSuggestions = JSON.parse(savedSuggestions);
            }
        }
        
        // è‡ªå®šä¹‰æ ‡ç­¾ç®¡ç† - ä»æ•°æ®åº“åŠ è½½
        async function loadCustomTagsFromDatabase() {
            if (!supabase) return;
            
            try {
                const { data, error } = await supabase
                    .from('tags')
                    .select('*')
                    .order('created_at', { ascending: true });
                
                if (error) {
                    console.error('åŠ è½½æ ‡ç­¾å¤±è´¥:', error);
                    showMessage('ä»æœåŠ¡å™¨åŠ è½½æ ‡ç­¾å¤±è´¥', true);
                    return;
                }
                
                // æ¸…ç©ºç°æœ‰æ ‡ç­¾
                customTags = [];
                
                // å°†æ•°æ®åº“ä¸­çš„æ•°æ®è½¬æ¢ä¸ºåº”ç”¨æ ¼å¼
                if (data && data.length > 0) {
                    data.forEach(item => {
                        const tag = {
                            id: item.id,
                            name: item.name,
                            color: item.color,
                            createdAt: item.created_at
                        };
                        customTags.push(tag);
                    });
                    
                    showMessage('æ ‡ç­¾å·²ä»æœåŠ¡å™¨åŠ è½½', false);
                } else {
                    // å¦‚æœæ²¡æœ‰æ ‡ç­¾ï¼Œåˆ›å»ºé»˜è®¤æ ‡ç­¾
                    await createDefaultTags();
                }
                
                // æ¸²æŸ“æ ‡ç­¾
                renderCustomTags();
            } catch (error) {
                console.error('åŠ è½½æ ‡ç­¾å¼‚å¸¸:', error);
                showMessage('åŠ è½½æ ‡ç­¾è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯', true);
            }
        }
        
        // åˆ›å»ºé»˜è®¤æ ‡ç­¾
        async function createDefaultTags() {
            const defaultTags = [
                { name: 'å…¨éƒ¨', color: '#4361ee' },
                { name: 'å·¥ä½œ', color: '#ff4d4d' },
                { name: 'ä¸ªäºº', color: '#2ec4b6' },
                { name: 'ç´§æ€¥', color: '#ff9f1c' }
            ];
            
            for (const tag of defaultTags) {
                await saveTagToDatabase(tag);
            }
            
            // é‡æ–°åŠ è½½æ ‡ç­¾
            loadCustomTagsFromDatabase();
        }
        
        // ä¿å­˜æ ‡ç­¾åˆ°æ•°æ®åº“
        async function saveTagToDatabase(tag) {
            if (!supabase) return null;
            
            try {
                const tagData = {
                    name: tag.name,
                    color: tag.color,
                    created_at: new Date().toISOString()
                };
                
                let result;
                if (tag.id) {
                    // æ›´æ–°ç°æœ‰æ ‡ç­¾
                    result = await supabase
                        .from('tags')
                        .update(tagData)
                        .eq('id', tag.id)
                        .select();
                } else {
                    // åˆ›å»ºæ–°æ ‡ç­¾
                    result = await supabase
                        .from('tags')
                        .insert([tagData])
                        .select();
                    
                    // è·å–æ–°åˆ›å»ºçš„æ ‡ç­¾ID
                    if (result.data && result.data.length > 0) {
                        tag.id = result.data[0].id;
                    }
                }
                
                if (result.error) {
                    throw result.error;
                }
                
                showMessage('æ ‡ç­¾å·²ä¿å­˜åˆ°äº‘ç«¯', false);
                return tag;
            } catch (error) {
                console.error('ä¿å­˜æ ‡ç­¾åˆ°æ•°æ®åº“å¤±è´¥:', error);
                showMessage('åŒæ­¥æ ‡ç­¾åˆ°æœåŠ¡å™¨å¤±è´¥', true);
                return null;
            }
        }
        
        // ä»æ•°æ®åº“åˆ é™¤æ ‡ç­¾
        async function deleteTagFromDatabase(tagId) {
            if (!supabase) return false;
            
            try {
                const { error } = await supabase
                    .from('tags')
                    .delete()
                    .eq('id', tagId);
                
                if (error) {
                    throw error;
                }
                
                showMessage('æ ‡ç­¾å·²ä»äº‘ç«¯åˆ é™¤', false);
                return true;
            } catch (error) {
                console.error('ä»æ•°æ®åº“åˆ é™¤æ ‡ç­¾å¤±è´¥:', error);
                showMessage('ä»æœåŠ¡å™¨åˆ é™¤æ ‡ç­¾å¤±è´¥', true);
                return false;
            }
        }
        
        // è‡ªå®šä¹‰æ ‡ç­¾ç®¡ç†
        function loadCustomTags() {
            // ç°åœ¨ä»æ•°æ®åº“åŠ è½½æ ‡ç­¾
            loadCustomTagsFromDatabase();
        }
        
        function renderCustomTags() {
            // æ¸²æŸ“åˆ—è¡¨è§†å›¾æ ‡ç­¾
            const listTagsContainer = document.getElementById('listTagsContainer');
            listTagsContainer.innerHTML = '';
            
            // æ¸²æŸ“å›¾ç‰‡ç®¡ç†è§†å›¾æ ‡ç­¾
            const imageTagsContainer = document.getElementById('imageTagsContainer');
            imageTagsContainer.innerHTML = '';
            
            customTags.forEach(tag => {
                // åˆ—è¡¨è§†å›¾æ ‡ç­¾
                const listTag = document.createElement('div');
                listTag.className = 'custom-tag' + (tag.id === customTags[0]?.id ? ' active' : '');
                listTag.dataset.category = tag.id;
                listTag.style.backgroundColor = tag.color;
                listTag.style.color = 'white';
                
                listTag.innerHTML = `
                    ${tag.name}
                    <span class="custom-tag-edit" data-id="${tag.id}">âœï¸</span>
                    ${tag.id !== customTags[0]?.id ? '<span class="custom-tag-delete" data-id="${tag.id}">Ã—</span>' : ''}
                `;
                
                listTag.addEventListener('click', function(e) {
                    if (!e.target.classList.contains('custom-tag-edit') && !e.target.classList.contains('custom-tag-delete')) {
                        // æ¿€æ´»é€‰ä¸­çš„æ ‡ç­¾
                        document.querySelectorAll('#listTagsContainer .custom-tag').forEach(t => {
                            t.classList.remove('active');
                        });
                        this.classList.add('active');
                        
                        // ç­›é€‰ä»»åŠ¡
                        filterTasksByCategory(tag.id);
                    }
                });
                
                const listEditBtn = listTag.querySelector('.custom-tag-edit');
                listEditBtn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    openEditTagModal(tag.id);
                });
                
                // æ·»åŠ åˆ é™¤æŒ‰é’®äº‹ä»¶ï¼ˆé™¤äº†ç¬¬ä¸€ä¸ªæ ‡ç­¾ï¼‰
                if (tag.id !== customTags[0]?.id) {
                    const listDeleteBtn = listTag.querySelector('.custom-tag-delete');
                    listDeleteBtn.addEventListener('click', function(e) {
                        e.stopPropagation();
                        deleteTag(tag.id);
                    });
                }
                
                listTagsContainer.appendChild(listTag);
                
                // å›¾ç‰‡ç®¡ç†è§†å›¾æ ‡ç­¾
                const imageTag = document.createElement('div');
                imageTag.className = 'custom-tag' + (tag.id === customTags[0]?.id ? ' active' : '');
                imageTag.dataset.category = tag.id;
                imageTag.style.backgroundColor = tag.color;
                imageTag.style.color = 'white';
                
                imageTag.innerHTML = `
                    ${tag.name}
                    <span class="custom-tag-edit" data-id="${tag.id}">âœï¸</span>
                    ${tag.id !== customTags[0]?.id ? '<span class="custom-tag-delete" data-id="${tag.id}">Ã—</span>' : ''}
                `;
                
                imageTag.addEventListener('click', function(e) {
                    if (!e.target.classList.contains('custom-tag-edit') && !e.target.classList.contains('custom-tag-delete')) {
                        // æ¿€æ´»é€‰ä¸­çš„æ ‡ç­¾
                        document.querySelectorAll('#imageTagsContainer .custom-tag').forEach(t => {
                            t.classList.remove('active');
                        });
                        this.classList.add('active');
                        
                        // ç­›é€‰å›¾ç‰‡
                        imageCategoryFilter = tag.id;
                        filterImagesByCategory();
                    }
                });
                
                const imageEditBtn = imageTag.querySelector('.custom-tag-edit');
                imageEditBtn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    openEditTagModal(tag.id);
                });
                
                // æ·»åŠ åˆ é™¤æŒ‰é’®äº‹ä»¶ï¼ˆé™¤äº†ç¬¬ä¸€ä¸ªæ ‡ç­¾ï¼‰
                if (tag.id !== customTags[0]?.id) {
                    const imageDeleteBtn = imageTag.querySelector('.custom-tag-delete');
                    imageDeleteBtn.addEventListener('click', function(e) {
                        e.stopPropagation();
                        deleteTag(tag.id);
                    });
                }
                
                imageTagsContainer.appendChild(imageTag);
            });
            
            // æ·»åŠ "æ·»åŠ æ ‡ç­¾"æŒ‰é’®
            const addListTagBtn = document.createElement('button');
            addListTagBtn.className = 'add-tag-btn';
            addListTagBtn.id = 'addTagBtn';
            addListTagBtn.textContent = '+ æ·»åŠ æ ‡ç­¾';
            addListTagBtn.addEventListener('click', openEditTagModal);
            listTagsContainer.appendChild(addListTagBtn);
            
            const addImageTagBtn = document.createElement('button');
            addImageTagBtn.className = 'add-tag-btn';
            addImageTagBtn.id = 'addImageTagBtn';
            addImageTagBtn.textContent = '+ æ·»åŠ æ ‡ç­¾';
            addImageTagBtn.addEventListener('click', openEditTagModal);
            imageTagsContainer.appendChild(addImageTagBtn);
            
            // æ›´æ–°åˆ†ç±»é€‰æ‹©å™¨
            updateCategorySelectors();
        }
        
        function openEditTagModal(tagId = null) {
            editingTagId = tagId;
            
            if (tagId) {
                // ç¼–è¾‘ç°æœ‰æ ‡ç­¾
                const tag = customTags.find(t => t.id === tagId);
                if (tag) {
                    document.getElementById('editTagModalTitle').textContent = 'ç¼–è¾‘æ ‡ç­¾';
                    document.getElementById('editTagName').value = tag.name;
                    document.getElementById('editTagColor').value = tag.color;
                }
            } else {
                // æ·»åŠ æ–°æ ‡ç­¾
                document.getElementById('editTagModalTitle').textContent = 'æ·»åŠ æ–°æ ‡ç­¾';
                document.getElementById('editTagName').value = '';
                document.getElementById('editTagColor').value = '#4361ee';
            }
            
            showModal('editTagModal');
        }
        
        async function saveEditedTag() {
            const name = document.getElementById('editTagName').value.trim();
            const color = document.getElementById('editTagColor').value;
            
            if (!name) {
                alert('è¯·è¾“å…¥æ ‡ç­¾åç§°');
                return;
            }
            
            let tag;
            if (editingTagId) {
                // æ›´æ–°ç°æœ‰æ ‡ç­¾
                const tagIndex = customTags.findIndex(t => t.id === editingTagId);
                if (tagIndex !== -1) {
                    tag = customTags[tagIndex];
                    tag.name = name;
                    tag.color = color;
                }
            } else {
                // æ·»åŠ æ–°æ ‡ç­¾
                tag = {
                    name: name,
                    color: color
                };
            }
            
            // ä¿å­˜åˆ°æ•°æ®åº“
            const savedTag = await saveTagToDatabase(tag);
            if (savedTag) {
                if (editingTagId) {
                    // æ›´æ–°ç°æœ‰æ ‡ç­¾
                    const tagIndex = customTags.findIndex(t => t.id === editingTagId);
                    if (tagIndex !== -1) {
                        customTags[tagIndex] = savedTag;
                    }
                } else {
                    // æ·»åŠ æ–°æ ‡ç­¾
                    customTags.push(savedTag);
                }
                
                renderCustomTags();
                hideModal('editTagModal');
                
                // è®°å½•æ“ä½œæ—¥å¿—
                logOperation('system', `${editingTagId ? 'ç¼–è¾‘' : 'æ·»åŠ '}æ ‡ç­¾ï¼š"${name}"`);
            }
        }
        
        // åˆ é™¤æ ‡ç­¾
        async function deleteTag(tagId) {
            if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæ ‡ç­¾å—ï¼Ÿä½¿ç”¨æ­¤æ ‡ç­¾çš„ä»»åŠ¡å’Œå›¾ç‰‡å°†ä¿ç•™ï¼Œä½†ä¼šå¤±å»æ ‡ç­¾åˆ†ç±»ã€‚')) {
                const tagIndex = customTags.findIndex(t => t.id === tagId);
                if (tagIndex !== -1) {
                    const tag = customTags[tagIndex];
                    
                    // ä»æ•°æ®åº“åˆ é™¤
                    const success = await deleteTagFromDatabase(tagId);
                    if (success) {
                        // è®°å½•æ“ä½œæ—¥å¿—
                        logOperation('delete', `åˆ é™¤æ ‡ç­¾ï¼š"${tag.name}"`);
                        
                        // ä»æ•°ç»„ä¸­ç§»é™¤
                        customTags.splice(tagIndex, 1);
                        
                        // é‡æ–°æ¸²æŸ“æ ‡ç­¾
                        renderCustomTags();
                    }
                }
            }
        }
        
        function getCategoryNameById(categoryId) {
            const tag = customTags.find(t => t.id === categoryId);
            return tag ? tag.name : categoryId;
        }
        
        function updateCategorySelectors() {
            // æ›´æ–°ä»»åŠ¡ç¼–è¾‘æ¨¡æ€æ¡†çš„åˆ†ç±»é€‰æ‹©å™¨
            const taskCategorySelect = document.getElementById('editTaskCategory');
            taskCategorySelect.innerHTML = '';
            
            // æ›´æ–°å›¾ç‰‡ç¼–è¾‘æ¨¡æ€æ¡†çš„åˆ†ç±»é€‰æ‹©å™¨
            const imageCategorySelect = document.getElementById('editImageCategory');
            imageCategorySelect.innerHTML = '';
            
            customTags.forEach(tag => {
                if (tag.id !== customTags[0]?.id) {
                    const taskOption = document.createElement('option');
                    taskOption.value = tag.id;
                    taskOption.textContent = tag.name;
                    taskCategorySelect.appendChild(taskOption);
                    
                    const imageOption = document.createElement('option');
                    imageOption.value = tag.id;
                    imageOption.textContent = tag.name;
                    imageCategorySelect.appendChild(imageOption);
                }
            });
        }
        
        function filterTasksByCategory(categoryId) {
            // è¿™é‡Œå¯ä»¥å®ç°æŒ‰åˆ†ç±»ç­›é€‰ä»»åŠ¡çš„åŠŸèƒ½
            // ç”±äºæ—¶é—´å…³ç³»ï¼Œè¿™é‡Œåªæ›´æ–°UIçŠ¶æ€ï¼Œå®é™…ç­›é€‰é€»è¾‘éœ€è¦æ ¹æ®å…·ä½“éœ€æ±‚å®ç°
            console.log(`ç­›é€‰ä»»åŠ¡åˆ†ç±»: ${getCategoryNameById(categoryId)}`);
        }
        
        // åˆå§‹åŒ–æ—¶åŠ è½½å»ºè®®
        loadSuggestionsFromLocalStorage();
    </script>
</body>
</html>
